
status() {
  NL=`$IPTABLES -nL | wc -l`
  if [ $NL -lt 9 ]; then
    echo "ERROR: Policy not loaded"
    exit 1
  else
    echo "OK. Polilcy loaded."
  fi 
}

# Verify that we have all the needed commands.
check_cmds

ACTION="$1"
test -z "$ACTION" && ACTION="start"

case "$ACTION" in
  start)
    greeting_msg
    load_nat_modules
    reset_all
    default_filter_policy DROP
    policy_load
    options_load
    ;;

  stop)
    reset_all
    default_filter_policy ACCEPT
    ;;

  restart|reload)
    $0 stop
    $0 start
    ;;

  block)
    reset_all
    default_filter_policy DROP
    ;;

  status)
    status
    ;;

  install)
    chmod 700 "$0"

    if [ "`cat /etc/issue | grep EdgeOS`" ]; then
      chown root:vyattacfg "$0"
      INSTALL_DIR="/config/scripts/post-config.d"
    else
      chown root:root "$0"
      INSTALL_DIR="/etc/fwcloud"
    fi

    test ! -d "$INSTALL_DIR" && {
      mkdir -m 700 -p "$INSTALL_DIR"
      chown root:root "$INSTALL_DIR"
    }

    mv "$0" "$INSTALL_DIR"

    if [ "$SYSTEMCTL" -a ! -f "$SYSTEMD_FILE" ]; then
      create_systemd_service
      $SYSTEMCTL enable fwcloud
    fi

    # Make sure that changes are written to disk.
    sync
    ;;

  *)
    echo "Usage $0 [start|stop|restart|reload|block|status|install]"
    ;;
esac

exit 0
