<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>models/policy_r__interface.js - FWCloud API REST Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://foswiki.soltecsis.com/codedoc/soltecsis-logo1.png" title="FWCloud API REST Documentation"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ClusterRouter.html">ClusterRouter</a></li>
                                <li><a href="../classes/FirewallModel.html">FirewallModel</a></li>
                                <li><a href="../classes/FirewallRouter.html">FirewallRouter</a></li>
                                <li><a href="../classes/IpobjsRouter.html">IpobjsRouter</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ClusterRouter.html">ClusterRouter</a></li>
                                <li><a href="../modules/FirewallModel.html">FirewallModel</a></li>
                                <li><a href="../modules/FirewallRouter.html">FirewallRouter</a></li>
                                <li><a href="../modules/IpobjsRouter.html">IpobjsRouter</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: models/policy_r__interface.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var db = require(&#x27;../db.js&#x27;);
var async = require(&#x27;async&#x27;);

//create object
var policy_r__interfaceModel = {};
var tableModel = &quot;policy_r__interface&quot;;

/**
 * Property Logger to manage App logs
 *
 * @property logger
 * @type log4js/app
 * 
 */
var logger = require(&#x27;log4js&#x27;).getLogger(&quot;app&quot;);

//Get All policy_r__interface by policy_r
policy_r__interfaceModel.getPolicy_r__interfaces_rule = function (interface, callback) {

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE interface = &#x27; + connection.escape(interface) + &#x27; ORDER by interface_order&#x27;;
        connection.query(sql, function (error, rows) {
            if (error)
                callback(error, null);
            else
                callback(null, rows);
        });
    });
};

//Get All policy_r__interface by policy_r
policy_r__interfaceModel.getPolicy_r__interfaces_interface = function (rule, callback) {

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; ORDER by interface_order&#x27;;
        connection.query(sql, function (error, rows) {
            if (error)
                callback(error, null);
            else
                callback(null, rows);
        });
    });
};




//Get policy_r__interface by  rule and  interface
policy_r__interfaceModel.getPolicy_r__interface = function (interface, rule, callback) {
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; AND interface = &#x27; + connection.escape(interface);
        connection.query(sql, function (error, row) {
            if (error)
                callback(error, null);
            else
                callback(null, row);
        });
    });
};



//Add new policy_r__interface
policy_r__interfaceModel.insertPolicy_r__interface = function (policy_r__interfaceData, callback) {


    //Check if IPOBJ TYPE is ALLOWED in this Position
    checkInterfacePosition(policy_r__interfaceData.rule, policy_r__interfaceData.interface, policy_r__interfaceData.position, function (error, data) {
        if (error) {
            callback(error, null);
        } else {
            allowed = data;
            if (allowed) {
                db.get(function (error, connection) {
                    if (error)
                        callback(error, null);
                    connection.query(&#x27;INSERT INTO &#x27; + tableModel + &#x27; SET ?&#x27;, policy_r__interfaceData, function (error, result) {
                        if (error) {
                            callback(error, null);
                        } else {
                            if (result.affectedRows &gt; 0) {
                                OrderList(policy_r__interfaceData.position_order, policy_r__interfaceData.rule, policy_r__interfaceData.position, 999999, policy_r__interfaceData.interface);

                                callback(null, {&quot;result&quot;: true, &quot;allowed&quot;: &quot;1&quot;});
                            } else {
                                callback(null, {&quot;result&quot;: false, &quot;allowed&quot;: &quot;1&quot;});
                            }
                        }
                    });
                });
            }
            else{
                 callback(null, {&quot;result&quot;: false, &quot;allowed&quot;: &quot;0&quot;});
            }
        }
    });
};

//Update policy_r__interface
policy_r__interfaceModel.updatePolicy_r__interface = function (rule, interface, old_position, old_position_order, policy_r__interfaceData, callback) {

    //Check if IPOBJ TYPE is ALLOWED in this Position
    checkInterfacePosition(policy_r__interfaceData.rule, policy_r__interfaceData.interface, policy_r__interfaceData.position, function (error, data) {
        if (error) {
            callback(error, null);
        } else {
            allowed = data;
            if (allowed) {

                db.get(function (error, connection) {
                    if (error)
                        callback(error, null);
                    var sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET position = &#x27; + connection.escape(policy_r__interfaceData.position) + &#x27;,&#x27; +
                            &#x27;negate = &#x27; + connection.escape(policy_r__interfaceData.negate) +
                            &#x27; WHERE rule = &#x27; + policy_r__interfaceData.rule + &#x27; AND  interface = &#x27; + policy_r__interfaceData.interface;

                    connection.query(sql, function (error, result) {
                        if (error) {
                            callback(error, null);
                        } else {
                            if (result.affectedRows &gt; 0) {
                                OrderList(policy_r__interfaceData.position_order, rule, old_position_order, interface);
                                callback(null, {&quot;result&quot;: true});
                            } else {
                                callback(null, {&quot;result&quot;: false});
                            }
                        }
                    });
                });
            }
        }
    });
};

//Update policy_r__interface POSITION AND RULE
policy_r__interfaceModel.updatePolicy_r__interface_position = function (rule, interface, old_position, old_position_order, new_rule, new_position, new_order, callback) {

    //Check if IPOBJ TYPE is ALLOWED in this Position
    checkInterfacePosition(new_rule, interface, new_position, function (error, data) {
        if (error) {
            callback(error, null);
        } else {
            allowed = data;
            if (allowed) {
                getNegateRulePosition(new_rule, new_position, function (error, data) {
                    if (error) {
                        logger.debug(&quot;ERROR : &quot;, error);
                    } else {
                        negate = data;
                        db.get(function (error, connection) {
                            if (error)
                                callback(error, null);


                            var sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET position = &#x27; + connection.escape(new_position) + &#x27;,&#x27; +
                                    &#x27;negate = &#x27; + connection.escape(negate) + &#x27;, &#x27; +
                                    &#x27;rule = &#x27; + connection.escape(new_rule) + &#x27;, &#x27; +
                                    &#x27;position_order = &#x27; + connection.escape(new_order) + &#x27; &#x27; +
                                    &#x27; WHERE rule = &#x27; + rule + &#x27; AND  interface = &#x27; + interface + &#x27; AND position=&#x27; + connection.escape(old_position);
                            logger.debug(sql);
                            connection.query(sql, function (error, result) {
                                if (error) {
                                    callback(error, null);
                                } else {
                                    if (result.affectedRows &gt; 0) {
                                        //Order New position
                                        OrderList(new_order, new_rule, new_position, 999999, interface);

                                        logger.debug(&quot;ORDENANDO OLD POSITION&quot;);
                                        logger.debug(result);
                                        //Order OLD position
                                        OrderList(999999, rule, old_position, old_position_order, interface);

                                        callback(null, {&quot;result&quot;: true, &quot;allowed&quot;: 1});
                                    } else {
                                        callback(null, {&quot;result&quot;: false, &quot;allowed&quot;: 1});
                                    }
                                }
                            });
                        });
                    }
                });
            } else {
                callback(null,{ &quot;result&quot;: false, &quot;allowed&quot;: 0});
            }
        }
    });
};

//Update NEGATE policy_r__interface for all interface in the rule
policy_r__interfaceModel.updatePolicy_r__interface_negate = function (rule, interface, position, negate, callback) {

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET &#x27; +
                &#x27; negate = &#x27; + connection.escape(negate) + &#x27; &#x27; +
                &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; AND position=&#x27; + connection.escape(position);

        connection.query(sql, function (error, result) {
            if (error) {
                callback(error, null);
            } else {
                callback(null, {&quot;result&quot;: true});
            }
        });
    });
};

//Update ORDER policy_r__interface
policy_r__interfaceModel.updatePolicy_r__interface_order = function (rule, interface, position, old_order, new_order, callback) {

    OrderList(new_order, rule, position, old_order, interface);
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET &#x27; +
                &#x27; position_order = &#x27; + connection.escape(new_order) + &#x27; &#x27; +
                &#x27; WHERE rule = &#x27; + rule + &#x27; AND  interface = &#x27; + interface;

        connection.query(sql, function (error, result) {
            if (error) {
                callback(error, null);
            } else {
                callback(null, {&quot;result&quot;: true});
            }
        });
    });
};

function OrderList(new_order, rule, position, old_order, interface) {
    var increment = &#x27;+1&#x27;;
    var order1 = new_order;
    var order2 = old_order;
    if (new_order &gt; old_order) {
        increment = &#x27;-1&#x27;;
        order1 = old_order;
        order2 = new_order;
    }

    logger.debug(&quot;---&gt; ORDENANDO RULE INTERFACE: &quot; + rule + &quot; POSITION: &quot; + position + &quot;  OLD_ORDER: &quot; + old_order + &quot;  NEW_ORDER: &quot; + new_order);

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET &#x27; +
                &#x27;position_order = position_order&#x27; + increment +
                &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; AND position=&#x27; + connection.escape(position) +
                &#x27; AND position_order&gt;=&#x27; + order1 + &#x27; AND position_order&lt;=&#x27; + order2 +
                &#x27; AND interface&lt;&gt;&#x27; + interface;
        logger.debug(sql);
        connection.query(sql);

    });

}
;

//Check if a object (type) can be inserted in a position type
function checkInterfacePosition(rule, id, position, callback) {

    var allowed = 0;
    db.get(function (error, connection) {
        if (error)
            callback(null, 0);
        var sql = &#x27;select A.allowed from ipobj_type__policy_position A  &#x27; +
                &#x27;inner join interface I on A.type=I.interface_type &#x27; +
                &#x27;inner join policy_position P on P.id=A.position &#x27; +
                &#x27; WHERE I.id = &#x27; + connection.escape(id) + &#x27; AND A.position=&#x27; + connection.escape(position) + &#x27; AND P.content=&quot;I&quot;&#x27;;
        logger.debug(sql);
        connection.query(sql, function (error, rows) {
            if (error)
                callback(error, null);
            else {
                if (rows.length &gt; 0) {
                    allowed = rows[0].allowed;
                    logger.debug(&quot;ALLOWED: &quot; + allowed);
                    if (allowed &gt; 0)
                        callback(null, 1);
                    else
                        callback(null, 0);
                } else
                    callback(null, 0);
            }
        });
    });
}

function getNegateRulePosition(rule, position, callback) {

    var Nneg = 0;
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT count(negate) as neg FROM &#x27; + tableModel +
                &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; AND position=&#x27; + connection.escape(position) +
                &#x27; AND negate=1&#x27;;
        logger.debug(&#x27;SQL: &#x27; + sql);
        connection.query(sql, function (error, rows) {
            if (error)
                callback(error, null);
            else {
                Nneg = rows[0].neg;
                logger.debug(&#x27;Nneg 1: &#x27; + Nneg);
                if (Nneg &gt; 0)
                    callback(null, 1);
                else
                    callback(null, 0);
            }
        });
    });
}

//Remove policy_r__interface with id to remove
policy_r__interfaceModel.deletePolicy_r__interface = function (rule, interface, position, old_order, callback) {

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sqlExists = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; AND  interface = &#x27; + connection.escape(interface) + &#x27; AND position=&#x27; + connection.escape(position);
        connection.query(sqlExists, function (error, row) {
            //If exists Id from policy_r__interface to remove
            if (row) {
                db.get(function (error, connection) {
                    var sql = &#x27;DELETE FROM &#x27; + tableModel + &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; AND  interface = &#x27; + connection.escape(interface) + &#x27; AND position=&#x27; + connection.escape(position);
                    logger.debug(sql);
                    connection.query(sql, function (error, result) {
                        if (error) {
                            callback(error, null);
                        } else {
                            if (result.affectedRows &gt; 0) {
                                OrderList(999999, rule, position, old_order, interface);
                                callback(null, {&quot;result&quot;: true, &quot;msg&quot;: &quot;deleted&quot;});
                            } else {
                                callback(null, {&quot;result&quot;: false, &quot;msg&quot;: &quot;notExist&quot;});
                            }
                        }
                    });
                });
            } else {
                callback(null, {&quot;result&quot;: false, &quot;msg&quot;: &quot;notExist&quot;});
            }
        });
    });
};

//Remove policy_r__interface with id to remove
policy_r__interfaceModel.deletePolicy_r__All = function (rule, callback) {

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sqlExists = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE rule = &#x27; + connection.escape(rule);
        connection.query(sqlExists, function (error, row) {
            //If exists Id from policy_r__interface to remove
            if (row) {
                logger.debug(&quot;DELETING INTERFACES FROM RULE: &quot; + rule);
                db.get(function (error, connection) {
                    var sql = &#x27;DELETE FROM &#x27; + tableModel + &#x27; WHERE rule = &#x27; + connection.escape(rule);
                    connection.query(sql, function (error, result) {
                        if (error) {
                            logger.debug(error);
                            callback(error, null);
                        } else {
                            if (result.affectedRows &gt; 0) {
                                callback(null, {&quot;result&quot;: true, &quot;msg&quot;: &quot;deleted&quot;});
                            } else {
                                callback(null, {&quot;result&quot;: false});
                            }
                        }
                    });
                });
            } else {
                callback(null, {&quot;result&quot;: false});
            }
        });
    });
};

//Order policy_r__interfaces Position
policy_r__interfaceModel.orderPolicyPosition = function (rule, position, callback) {

    logger.debug(&quot;DENTRO ORDER   Rule: &quot; + rule + &#x27;  Position: &#x27; + position);

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sqlPos = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; AND position= &#x27; + connection.escape(position) + &#x27; order by position_order&#x27;;
        logger.debug(sqlPos);
        connection.query(sqlPos, function (error, rows) {
            if (rows.length &gt; 0) {
                var order = 0;
                async.map(rows, function (row, callback1) {
                    order++;
                    db.get(function (error, connection) {
                        sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET position_order=&#x27; + order +
                                &#x27; WHERE rule = &#x27; + connection.escape(row.rule) +
                                &#x27; AND position=&#x27; + connection.escape(row.position) +
                                &#x27; AND interface=&#x27; + connection.escape(row.interface);
                        //logger.debug(sql);
                        connection.query(sql, function (error, result) {
                            if (error) {
                                callback1();
                            } else {
                                callback1();
                            }
                        });
                    });
                }, //Fin de bucle
                        function (err) {
                            callback(null, {&quot;result&quot;: true});
                        }

                );

            } else {
                callback(null, {&quot;result&quot;: false});
            }
        });
    });
};

//Order policy_r__interfaces Position
policy_r__interfaceModel.orderPolicy = function (rule, callback) {


    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sqlRule = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE rule = &#x27; + connection.escape(rule) + &#x27; order by position, position_order&#x27;;
        logger.debug(sqlRule);
        connection.query(sqlRule, function (error, rows) {
            if (rows.length &gt; 0) {
                var order = 0;
                var prev_position = 0;
                async.map(rows, function (row, callback1) {
                    var position = row.position;
                    if (position !== prev_position) {
                        order = 1;
                        prev_position = position;
                    } else
                        order++;

                    db.get(function (error, connection) {
                        sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET position_order=&#x27; + order +
                                &#x27; WHERE rule = &#x27; + connection.escape(row.rule) +
                                &#x27; AND position=&#x27; + connection.escape(row.position) +
                                &#x27; AND interface=&#x27; + connection.escape(row.interface);
                        //logger.debug(sql);
                        connection.query(sql, function (error, result) {
                            if (error) {
                                callback1();
                            } else {
                                callback1();
                            }
                        });
                    });
                }, //Fin de bucle
                        function (err) {
                            callback(null, {&quot;result&quot;: true});
                        }

                );

            } else {
                callback(null, {&quot;result&quot;: false});
            }
        });
    });
};

//Order policy_r__interfaces Position
policy_r__interfaceModel.orderAllPolicy = function (callback) {


    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sqlRule = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; ORDER by rule,position, position_order&#x27;;
        logger.debug(sqlRule);
        connection.query(sqlRule, function (error, rows) {
            if (rows.length &gt; 0) {
                var order = 0;
                var prev_rule = 0;
                var prev_position = 0;
                async.map(rows, function (row, callback1) {
                    var position = row.position;
                    var rule = row.rule;
                    if (position !== prev_position || rule !== prev_rule) {
                        order = 1;
                        prev_rule = rule;
                        prev_position = position;
                    } else
                        order++;

                    db.get(function (error, connection) {
                        sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET position_order=&#x27; + order +
                                &#x27; WHERE rule = &#x27; + connection.escape(row.rule) +
                                &#x27; AND position=&#x27; + connection.escape(row.position) +
                                &#x27; AND interface=&#x27; + connection.escape(row.interface);
                        //logger.debug(sql);
                        connection.query(sql, function (error, result) {
                            if (error) {
                                callback1();
                            } else {
                                callback1();
                            }
                        });
                    });
                }, //Fin de bucle
                        function (err) {
                            logger.debug(&quot;FIN De BUCLE&quot;);
                            callback(null, {&quot;result&quot;: true});
                        }

                );

            } else {
                callback(null, {&quot;result&quot;: false});
            }
        });
    });
};


//check if INTERFACE Exists in any rule
policy_r__interfaceModel.checkInterfaceInRule = function (interface, type, fwcloud, callback) {

    logger.debug(&quot;CHECK DELETING interface I POSITIONS:&quot; + interface + &quot; Type:&quot; + type + &quot;  fwcloud:&quot; + fwcloud);
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT count(*) as n FROM &#x27; + tableModel + &#x27; O INNER JOIN policy_r R on R.id=O.rule &#x27; +
                &#x27; INNER JOIN firewall F on F.id=R.firewall &#x27; +
                &#x27; INNER JOIN fwcloud C on C.id=F.fwcloud &#x27; +
                &#x27; inner join interface I on I.id=O.interface &#x27; +
                &#x27; WHERE I.id=&#x27; + connection.escape(interface) + &#x27; AND I.interface_type=&#x27; + connection.escape(type) +
                &#x27; AND C.id=&#x27; + connection.escape(fwcloud);
        logger.debug(sql);
        connection.query(sql, function (error, rows) {
            if (!error) {
                if (rows.length &gt; 0) {
                    if (rows[0].n &gt; 0) {
                        logger.debug(&quot;ALERT DELETING interface IN RULE:&quot; + interface + &quot; type: &quot; + type + &quot; fwcloud:&quot; + fwcloud + &quot; --&gt; FOUND IN &quot; + rows[0].n + &quot; RULES&quot;);
                        callback(null, {&quot;result&quot;: true});
                    } else {
                        callback(null, {&quot;result&quot;: false});
                    }
                } else {
                    callback(null, {&quot;result&quot;: false});
                }
            } else
                callback(null, {&quot;result&quot;: false});
        });
    });
};

//check if HOST ALL INTERFACEs Exists in any rule
policy_r__interfaceModel.checkHostAllInterfacesInRule = function (ipobj_host, fwcloud, callback) {

    logger.debug(&quot;CHECK DELETING HOST ALL interfaces I POSITIONS:&quot; + ipobj_host + &quot;  fwcloud:&quot; + fwcloud);
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT count(*) as n FROM &#x27; + tableModel + &#x27; O &#x27; +
                &#x27; inner join interface__ipobj J on J.interface=O.interface  &#x27; +
                &#x27; INNER JOIN policy_r R on R.id=O.rule &#x27; +
                &#x27; INNER JOIN firewall F on F.id=R.firewall &#x27; +
                &#x27; inner join fwcloud C on C.id=F.fwcloud &#x27; +
                &#x27; WHERE J.ipobj=&#x27; + connection.escape(ipobj_host) + &#x27; AND C.id=&#x27; + connection.escape(fwcloud);
        logger.debug(sql);
        connection.query(sql, function (error, rows) {
            if (!error) {
                if (rows.length &gt; 0) {
                    if (rows[0].n &gt; 0) {
                        logger.debug(&quot;ALERT DELETING HOST ALL interfaces IN RULE:&quot; + ipobj_host + &quot; fwcloud:&quot; + fwcloud + &quot; --&gt; FOUND IN &quot; + rows[0].n + &quot; RULES&quot;);
                        callback(null, {&quot;result&quot;: true});
                    } else {
                        callback(null, {&quot;result&quot;: false});
                    }
                } else {
                    callback(null, {&quot;result&quot;: false});
                }
            } else
                callback(null, {&quot;result&quot;: false});
        });
    });
};

//Search if HOST ALL INTERFACEs Exists in any rule
//SEARCH IPOBJ UNDER INTERFACES IN RULES  &#x27;I&#x27;  POSITIONS
policy_r__interfaceModel.searchInterfacesInRule = function (ipobj, fwcloud, callback) {

    logger.debug(&quot;SEARCH IPOBJ  interfaces I POSITIONS:&quot; + ipobj + &quot;  fwcloud:&quot; + fwcloud);
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT O.interface obj_id,K.name obj_name, K.interface_type obj_type_id,T.type obj_type_name, &#x27; +
                &#x27;C.id cloud_id, C.name cloud_name, R.firewall firewall_id, F.name firewall_name ,O.rule rule_id, R.rule_order,R.type rule_type,PT.name rule_type_name,    &#x27; +
                &#x27;O.position rule_position_id,  P.name rule_position_name,R.comment rule_comment &#x27; +
                &#x27;FROM  policy_r__interface O  &#x27; +
                &#x27;INNER JOIN interface K on K.id=O.interface &#x27; +
                &#x27;INNEr JOIN ipobj J ON J.interface=K.id &#x27; +
                &#x27;INNER JOIN policy_r R on R.id=O.rule  &#x27; +
                &#x27;INNER JOIN firewall F on F.id=R.firewall &#x27; +
                &#x27;inner join fwcloud C on C.id=F.fwcloud  &#x27; +
                &#x27;inner join ipobj_type T on T.id=K.interface_type &#x27; +
                &#x27;inner join policy_position P on P.id=O.position &#x27; +
                &#x27;inner join policy_type PT on PT.id=R.type &#x27; +
                &#x27; WHERE J.id=&#x27; + connection.escape(ipobj) + &#x27; AND C.id=&#x27; + connection.escape(fwcloud);
        logger.debug(sql);
        connection.query(sql, function (error, rows) {
            if (!error) {
                if (rows.length &gt; 0) {
                    logger.debug(&quot;FOUND interfaces IN RULE:&quot; + ipobj + &quot; fwcloud:&quot; + fwcloud + &quot; --&gt; FOUND IN &quot; + rows[0].n + &quot; RULES&quot;);
                    callback(null, {&quot;found&quot;: rows});

                } else {
                    callback(null, {&quot;found&quot;: &quot;&quot;});
                }
            } else
                callback(null, {&quot;found&quot;: &quot;&quot;});
        });
    });
};

//search if INTERFACE Exists in any rule I POSITIONS
policy_r__interfaceModel.SearchInterfaceInRules = function (interface, type, fwcloud, firewall, callback) {
    
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &quot;&quot;;
        if (firewall === null) {
            //Search interfaces in all Firewalls from Cloud
            logger.debug(&quot;SEARCH interface I POSITIONS IN ALL CLOUD&#x27;s Firewalls:&quot; + interface + &quot; Type:&quot; + type + &quot;  fwcloud:&quot; + fwcloud);
            sql = &#x27;SELECT O.interface obj_id,I.name obj_name, I.interface_type obj_type_id,T.type obj_type_name, &#x27; +
                    &#x27;C.id cloud_id, C.name cloud_name, R.firewall firewall_id, F.name firewall_name ,O.rule rule_id, R.rule_order,R.type rule_type, &#x27; +
                    &#x27;PT.name rule_type_name,O.position rule_position_id,  P.name rule_position_name,R.comment rule_comment &#x27; +
                    &#x27;FROM policy_r__interface O &#x27; +
                    &#x27;INNER JOIN policy_r R on R.id=O.rule   &#x27; +
                    &#x27;INNER JOIN firewall F on F.id=R.firewall   &#x27; +
                    &#x27;INNEr JOIN interface I on I.id=O.interface &#x27; +
                    &#x27;inner join ipobj_type T on T.id=I.interface_type &#x27; +
                    &#x27;inner join policy_position P on P.id=O.position &#x27; +
                    &#x27;inner join policy_type PT on PT.id=R.type &#x27; +
                    &#x27;inner join fwcloud C on C.id=F.fwcloud &#x27; +
                    &#x27; WHERE I.id=&#x27; + connection.escape(interface) + &#x27; AND I.interface_type=&#x27; + connection.escape(type) + &#x27; AND C.id=&#x27; + connection.escape(fwcloud);
        } else {
                //Search interfaces only in Firewall interface
            logger.debug(&quot;SEARCH interface I POSITIONS IN INTERFACE&#x27;s FIREWALL:&quot; + interface + &quot; Type:&quot; + type + &quot;  fwcloud:&quot; + fwcloud + &quot;  Firewall: &quot; + firewall);   
            sql = &#x27;SELECT O.interface obj_id,I.name obj_name, I.interface_type obj_type_id,T.type obj_type_name, &#x27; +
                    &#x27;C.id cloud_id, C.name cloud_name, R.firewall firewall_id, F.name firewall_name ,O.rule rule_id, R.rule_order,R.type rule_type, &#x27; +
                    &#x27;PT.name rule_type_name,O.position rule_position_id,  P.name rule_position_name,R.comment rule_comment &#x27; +
                    &#x27;FROM policy_r__interface O &#x27; +
                    &#x27;INNER JOIN policy_r R on R.id=O.rule   &#x27; +
                    &#x27;INNER JOIN firewall F on F.id=R.firewall   &#x27; +
                    &#x27;INNEr JOIN interface I on I.id=O.interface &#x27; +
                    &#x27;inner join ipobj_type T on T.id=I.interface_type &#x27; +
                    &#x27;inner join policy_position P on P.id=O.position &#x27; +
                    &#x27;inner join policy_type PT on PT.id=R.type &#x27; +
                    &#x27;inner join fwcloud C on C.id=F.fwcloud &#x27; +
                    &#x27; WHERE I.id=&#x27; + connection.escape(interface) + &#x27; AND I.interface_type=&#x27; + connection.escape(type) + 
                    &#x27; AND C.id=&#x27; + connection.escape(fwcloud) + &#x27; AND F.id=&#x27; + connection.escape(firewall) ;
        }
        logger.debug(sql);
        connection.query(sql, function (error, rows) {
            if (!error) {
                if (rows.length &gt; 0) {
                    logger.debug(&quot;FOUND interface IN RULES:&quot; + interface + &quot; type: &quot; + type + &quot; fwcloud:&quot; + fwcloud + &quot; --&gt; FOUND IN &quot; + rows.length + &quot; RULES&quot;);
                    callback(null, {&quot;found&quot;: rows});

                } else {
                    callback(null, {&quot;found&quot;: &quot;&quot;});
                }
            } else
                callback(null, {&quot;found&quot;: &quot;&quot;});
        });
    });
};

//Export the object
module.exports = policy_r__interfaceModel;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
