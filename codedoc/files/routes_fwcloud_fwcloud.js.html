<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routes/fwcloud/fwcloud.js - FWCloud API REST Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://foswiki.soltecsis.com/codedoc/soltecsis-logo1.png" title="FWCloud API REST Documentation"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ClusterRouter.html">ClusterRouter</a></li>
                                <li><a href="../classes/CompileRouter.html">CompileRouter</a></li>
                                <li><a href="../classes/FirewallModel.html">FirewallModel</a></li>
                                <li><a href="../classes/FirewallRouter.html">FirewallRouter</a></li>
                                <li><a href="../classes/FwcloudModel.html">FwcloudModel</a></li>
                                <li><a href="../classes/FwcloudRouter.html">FwcloudRouter</a></li>
                                <li><a href="../classes/IpobjModel.html">IpobjModel</a></li>
                                <li><a href="../classes/IpobjsRouter.html">IpobjsRouter</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Cluster.html">Cluster</a></li>
                                <li><a href="../modules/Compile.html">Compile</a></li>
                                <li><a href="../modules/Firewall.html">Firewall</a></li>
                                <li><a href="../modules/FirewallExport.html">FirewallExport</a></li>
                                <li><a href="../modules/Fwcloud.html">Fwcloud</a></li>
                                <li><a href="../modules/Ipobjs.html">Ipobjs</a></li>
                                <li><a href="../modules/OpenVPN.html">OpenVPN</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: routes/fwcloud/fwcloud.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Module to routing FWCloud requests
 * &lt;br&gt;BASE ROUTE CALL: &lt;b&gt;/fwclouds&lt;/b&gt;
 *
 * @module Fwcloud
 * 
 * 
 */

/**
 * Class to manage fwcloud routing
 * 
 * 
 * @class FwcloudRouter
 * 
 */

/**
 * Property  to manage express
 *
 * @property express
 * @type express
 */
var express = require(&#x27;express&#x27;);

/**
 * Property  to manage Fwcloud route
 *
 * @property router
 * @type express.Router 
 */
var router = express.Router();

/**
 * Property Model to manage API RESPONSE data: {{#crossLinkModule &quot;api_response&quot;}}{{/crossLinkModule}}
 *
 * @property api_resp
 * @type api_respModel
 * 
 */
var api_resp = require(&#x27;../../utils/api_response&#x27;);

/**
 * Property to identify Data Object
 *
 * @property objModel
 * @type text
 */
var objModel = &#x27;FWCLOUD&#x27;;

/**
 * Property Model to manage Fwcloud Data
 *
 * @property FwcloudModel
 * @type ../../models/fwcloud
 * 
 * 
 */
var FwcloudModel = require(&#x27;../../models/fwcloud/fwcloud&#x27;);

/**
 * Property Logger to manage App logs
 *
 * @attribute logger
 * @type log4js/app
 * 
 */
var logger = require(&#x27;log4js&#x27;).getLogger(&quot;app&quot;);

var utilsModel = require(&quot;../../utils/utils.js&quot;);

var fwcTreemodel = require(&#x27;../../models/tree/tree&#x27;);

const restrictedCheck = require(&#x27;../../middleware/restricted&#x27;);


/**
 * Get Fwclouds by User
 * 
 * 
 * &gt; ROUTE CALL:  __/:iduser__      
 * &gt; METHOD:  __GET__
 * 
 * @method getFwcloudByUser
 * 
 * @param {Integer} iduser User identifier
 * 
 * @return {JSON} Returns &#x60;JSON&#x60; Data from Fwcloud
 * @example #### JSON RESPONSE
 *    
 *       {&quot;data&quot; : [
 *          {  //Data Fwcloud 1       
 *           &quot;id&quot; : ,            //Fwcloud Identifier
 *           &quot;created_at&quot; : ,    //Date Created
 *           &quot;updated_at&quot; : ,    //Date Updated
 *           &quot;updated_by&quot; : ,   //User last update
 *          },
 *          {....}, //Data Fwcloud 2
 *          {....}  //Data Fwcloud ...n 
 *         ]
 *       };
 * 
 */
router.get(&#x27;/all/get&#x27;, (req, res) =&gt; {
	FwcloudModel.getFwclouds(req.session.user_id, (error, data) =&gt; {
		if (data &amp;&amp; data.length &gt; 0) //Get data
			api_resp.getJson(data, api_resp.ACR_OK, &#x27;&#x27;, objModel, null, jsonResp =&gt; res.status(200).json(jsonResp));
		else //Get error 
			api_resp.getJson(data, api_resp.ACR_NOTEXIST, &#x27;not found&#x27;, objModel, error, jsonResp =&gt; res.status(200).json(jsonResp));
	});
});

/* Get fwcloud by Id */
/**
 * Get Fwclouds by ID and User
 * 
 * &lt;br&gt;ROUTE CALL:  &lt;b&gt;/get&lt;/b&gt;
 * &lt;br&gt;METHOD: &lt;b&gt;PUT&lt;/b&gt;
 *
 * @method getFwcloudByUser_and_ID_V2
 * 
 * @param {Integer} iduser User identifier
 * @param {Integer} id Fwcloud identifier
 * 
 * @return {JSON} Returns Json Data from Fwcloud
 */
router.put(&#x27;/get&#x27;, (req, res) =&gt; {
	FwcloudModel.getFwcloud(req.session.user_id, req.body.fwcloud, (error, data) =&gt; {
		if (data &amp;&amp; data.length &gt; 0) //get fwcloud data
			api_resp.getJson(data, api_resp.ACR_OK, &#x27;&#x27;, objModel, null, jsonResp =&gt; res.status(200).json(jsonResp));
		else //get error
			api_resp.getJson(data, api_resp.ACR_NOTEXIST, &#x27;not found&#x27;, objModel, error, jsonResp =&gt; res.status(200).json(jsonResp));
	});
});


/**
 * CREATE New fwcloud
 * 
 * 
 * &gt; ROUTE CALL:  __/fwcloud/fwcloud__      
 * &gt; METHOD:  __POST__
 * 
 *
 * @method AddFwcloud
 * 
 * @param {Integer} id Fwcloud identifier (AUTO)
 * @param {String} name Fwcloud Name
 * @param {String} [comment] Fwcloud comment
 * 
 * @return {JSON} Returns Json result
 * @example 
 * #### JSON RESPONSE OK:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;insertId : ID,   //fwcloud identifier           
 *          }
 *         ]
 *       };
 *       
 * #### JSON RESPONSE ERROR:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : ERROR,   //Text Error
 *          }
 *         ]
 *       };
 */
router.post(&#x27;/&#x27;, (req, res) =&gt; {
	var fwcloudData = {
		name: req.body.name,
		image: req.body.image,
		comment: req.body.comment
	};

	FwcloudModel.insertFwcloud(req.session.user_id, fwcloudData, async(error, data) =&gt; {
		if (data &amp;&amp; data.insertId) {
			logger.debug(&quot;insertFwcloud: &quot;, data);
			var dataresp = { &quot;insertId&quot;: data.insertId };

			//CREATE INITIAL STRUCTURE 
			logger.debug(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt; CLOUD CREATED: &quot;, data.insertId, &quot; - &quot;, fwcloudData.name);
			try {
				req.body.fwcloud = data.insertId;
				await fwcTreemodel.createAllTreeCloud(req);
				await utilsModel.createFwcloudDataDir(req.body.fwcloud);
			} catch (error) { return api_resp.getJson(null, api_resp.ACR_ERROR, &#x27;Error creating cloud&#x27;, objModel, error, jsonResp =&gt; res.status(200).json(jsonResp)); }

			api_resp.getJson(dataresp, api_resp.ACR_INSERTED_OK, &#x27;INSERTED OK&#x27;, objModel, null, jsonResp =&gt; res.status(200).json(jsonResp));
		} else api_resp.getJson(data, api_resp.ACR_ERROR, &#x27;Error&#x27;, objModel, error, jsonResp =&gt; res.status(200).json(jsonResp));
	});
});


/**
 * UPDATE fwcloud
 * 
 * 
 * &gt; ROUTE CALL:  __/fwcloud/fwcloud__      
 * &gt; METHOD:  __PUT__
 * 
 *
 * @method UpdateFwcloud
 * 
 * @param {Integer} id Fwcloud identifier
 * @optional
 * @param {Integer} iduser User identifier 
 * @param {String} name Fwcloud Name
 * 
 * @return {JSON} Returns Json result
 * @example 
 * #### JSON RESPONSE OK:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : &quot;success&quot;,   //result
 *          }
 *         ]
 *       };
 *       
 * #### JSON RESPONSE ERROR:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : ERROR,   //Text Error
 *          }
 *         ]
 *       };
 */
router.put(&#x27;/&#x27;, (req, res) =&gt; {
	//Save fwcloud data into objet
	var fwcloudData = { id: req.body.fwcloud, name: req.body.name, image: req.body.image, comment: req.body.comment, user: req.session.user_id };

	FwcloudModel.updateFwcloud(fwcloudData, function(error, data) {
		//Saved ok
		if (data &amp;&amp; data.result) {
			api_resp.getJson(data, api_resp.ACR_UPDATED_OK, &#x27;UPDATED OK&#x27;, objModel, null, function(jsonResp) {
				res.status(200).json(jsonResp);
			});
		} else {
			api_resp.getJson(data, api_resp.ACR_ERROR, &#x27;Error&#x27;, objModel, error, function(jsonResp) {
				res.status(200).json(jsonResp);
			});
		}
	});
});

// API call for check deleting restrictions.
router.put(&quot;/restricted&quot;,
	restrictedCheck.fwcloud,
	(req, res) =&gt; api_resp.getJson(null, api_resp.ACR_OK, &#x27;&#x27;, objModel, null, jsonResp =&gt; res.status(200).json(jsonResp)));

/**
 * DELETE fwcloud
 * 
 * 
 * &gt; ROUTE CALL:  __/fwcloud/fwcloud__      
 * &gt; METHOD:  __DELETE__
 * 
 *
 * @method DeleteFwcloud
 * 
 * @param {Integer} fwcloud Fwcloud identifier
 * @optional
 * 
 * @return {JSON} Returns Json result
 * @example 
 * #### JSON RESPONSE OK:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : &quot;success&quot;,   //result
 *          }
 *         ]
 *       };
 *       
 * #### JSON RESPONSE ERROR:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : ERROR,   //Text Error
 *          }
 *         ]
 *       };
 */
//FALTA CONTROLAR BORRADO EN CASCADA y PERMISOS 
router.put(&quot;/del&quot;,
	restrictedCheck.fwcloud,
	async(req, res) =&gt; {
		// Remove the fwcloud data dir.
		try {
			await utilsModel.removeFwcloudDataDir(req.body.fwcloud);
		} catch (error) { return api_resp.getJson(null, api_resp.ACR_ERROR, &#x27;Error removing data directory&#x27;, objModel, error, jsonResp =&gt; res.status(200).json(jsonResp)); }

		FwcloudModel.deleteFwcloud(req.session.user_id, req.body.fwcloud, (error, data) =&gt; {
			if (data &amp;&amp; data.result)
				api_resp.getJson(data, api_resp.ACR_DELETED_OK, &#x27;&#x27;, objModel, null, jsonResp =&gt; res.status(200).json(jsonResp));
			else
				api_resp.getJson(data, api_resp.ACR_ERROR, &#x27;Error&#x27;, objModel, error, jsonResp =&gt; res.status(200).json(jsonResp));
		});
	});


/**
 * Lock fwcloud status
 * 
 * 
 * &gt; ROUTE CALL:  __/fwcloud/fwcloud/lock__      
 * &gt; METHOD:  __PUT__
 * 
 *
 * @method UpdateFwcloudLock
 * 
 * @param {Integer} fwcloud Fwcloud id
 * @optional
 * @param {Integer} iduser User identifier
 * 
 * @return {JSON} Returns Json result
 * @example 
 * #### JSON RESPONSE OK:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : &quot;success&quot;,   //result
 *          }
 *         ]
 *       };
 *       
 * #### JSON RESPONSE ERROR:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : ERROR,   //Text Error
 *          }
 *         ]
 *       };
 */
router.put(&#x27;/lock&#x27;, (req, res) =&gt; {
	//Save fwcloud data into objet
	var fwcloudData = { fwcloud: req.body.fwcloud, iduser: req.session.user_id };

	FwcloudModel.updateFwcloudLock(fwcloudData)
		.then(data =&gt; {
			if (data.result) {
				logger.info(&quot;FWCLOUD: &quot; + fwcloudData.fwcloud + &quot;  LOCKED BY USER: &quot; + fwcloudData.iduser);
				api_resp.getJson(data, api_resp.ACR_UPDATED_OK, &#x27;FWCLOUD LOCKED OK&#x27;, objModel, null, function(jsonResp) {
					res.status(200).json(jsonResp);
				});
			} else {
				logger.info(&quot;NOT ACCESS FOR LOCKING FWCLOUD: &quot; + fwcloudData.fwcloud + &quot;  BY USER: &quot; + fwcloudData.iduser);
				api_resp.getJson(data, api_resp.ACR_ERROR, &#x27;Error locking&#x27;, objModel, null, function(jsonResp) {
					res.status(200).json(jsonResp);
				});
			}
		})
		.catch(r =&gt; {
			logger.info(&quot;ERROR LOCKING FWCLOUD: &quot; + fwcloudData.fwcloud + &quot;  BY USER: &quot; + fwcloudData.iduser);
			api_resp.getJson(null, api_resp.ACR_ERROR, &#x27;Error locking&#x27;, objModel, r, function(jsonResp) {
				res.status(200).json(jsonResp);
			});
		});


});

/**
 * Unlock fwcloud status
 * 
 * 
 * &gt; ROUTE CALL:  __/fwcloud/fwcloud/unlock__      
 * &gt; METHOD:  __PUT__
 * 
 *
 * @method UpdateFwcloudUnlock
 * 
 * @param {Integer} fwcloud Fwcloud cloud
 * @optional
 * @param {Integer} iduser User identifier
 * 
 * @return {JSON} Returns Json result
 * @example 
 * #### JSON RESPONSE OK:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : &quot;success&quot;,   //result
 *          }
 *         ]
 *       };
 *       
 * #### JSON RESPONSE ERROR:
 *    
 *       {&quot;data&quot; : [
 *          { 
 *           &quot;msg : ERROR,   //Text Error
 *          }
 *         ]
 *       };
 */
router.put(&#x27;/unlock&#x27;, (req, res) =&gt; {
	//Save fwcloud data into objet
	var fwcloudData = { id: req.body.fwcloud, iduser: req.session.user_id };
	FwcloudModel.updateFwcloudUnlock(fwcloudData)
		.then(data =&gt; {
			if (data.result) {
				logger.info(&quot;FWCLOUD: &quot; + fwcloudData.id + &quot;  UNLOCKED BY USER: &quot; + fwcloudData.iduser);
				api_resp.getJson(data, api_resp.ACR_UPDATED_OK, &#x27;FWCLOUD UNLOCKED OK&#x27;, objModel, null, function(jsonResp) {
					res.status(200).json(jsonResp);
				});
			} else {
				logger.info(&quot;NOT ACCESS FOR UNLOCKING FWCLOUD: &quot; + fwcloudData.id + &quot;  BY USER: &quot; + fwcloudData.iduser);
				api_resp.getJson(data, api_resp.ACR_ERROR, &#x27;Error unlocking&#x27;, objModel, null, function(jsonResp) {
					res.status(200).json(jsonResp);
				});
			}
		})
		.catch(error =&gt; {
			logger.info(&quot;ERROR UNLOCKING FWCLOUD: &quot; + fwcloudData.id + &quot;  BY USER: &quot; + fwcloudData.iduser);
			api_resp.getJson(null, api_resp.ACR_ERROR, &#x27;Error unlocking&#x27;, objModel, error, function(jsonResp) {
				res.status(200).json(jsonResp);
			});
		});

});
/* Get locked Status of fwcloud by Id */
/**
 * Get Locked status of Fwcloud by ID and User
 * 
 * &lt;br&gt;ROUTE CALL:  &lt;b&gt;/locked&lt;/b&gt;
 * &lt;br&gt;METHOD: &lt;b&gt;GET&lt;/b&gt;
 *
 * @method getLockedStatusFwcloudByUser_and_ID
 * @param {Integer} iduser User identifier
 * @param {Integer} id Fwcloud identifier
 * 
 * @return {JSON} Returns Json Data from Fwcloud
 */
router.get(&#x27;/lock/get&#x27;, (req, res) =&gt; {
	var iduser = req.session.user_id;
	var fwcloud = req.params.fwcloud;
	if (!isNaN(fwcloud)) {
		FwcloudModel.getFwcloud(iduser, fwcloud, function(error, data) {
			//get fwcloud data
			if (data &amp;&amp; data.length &gt; 0) {

				var resp = { &quot;locked&quot;: false, &quot;at&quot;: &quot;&quot;, &quot;by&quot;: &quot;&quot; };
				if (data[0].locked === 1) {
					resp = { &quot;locked&quot;: true, &quot;at&quot;: data[0].locked_at, &quot;by&quot;: data[0].locked_by };
				}

				api_resp.getJson(resp, api_resp.ACR_OK, &#x27;&#x27;, &quot;&quot;, null, function(jsonResp) {
					res.status(200).json(jsonResp);
				});
			}
			//get error
			else {
				api_resp.getJson(data, api_resp.ACR_NOTEXIST, &#x27;not found&#x27;, objModel, null, function(jsonResp) {
					res.status(200).json(jsonResp);
				});
			}
		});
	}
	//id must be numeric
	else {
		api_resp.getJson(null, api_resp.ACR_NOTEXIST, &#x27;not found&#x27;, objModel, null, function(jsonResp) {
			res.status(200).json(jsonResp);
		});
	}
});


module.exports = router;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
