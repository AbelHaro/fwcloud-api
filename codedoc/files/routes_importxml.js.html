<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routes/importxml.js - FWCloud API REST Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://foswiki.soltecsis.com/codedoc/soltecsis-logo1.png" title="FWCloud API REST Documentation"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ClusterRouter.html">ClusterRouter</a></li>
                                <li><a href="../classes/FirewallModel.html">FirewallModel</a></li>
                                <li><a href="../classes/FirewallRouter.html">FirewallRouter</a></li>
                                <li><a href="../classes/IpobjsRouter.html">IpobjsRouter</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ClusterRouter.html">ClusterRouter</a></li>
                                <li><a href="../modules/FirewallModel.html">FirewallModel</a></li>
                                <li><a href="../modules/FirewallRouter.html">FirewallRouter</a></li>
                                <li><a href="../modules/IpobjsRouter.html">IpobjsRouter</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: routes/importxml.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var express = require(&#x27;express&#x27;);
var router = express.Router();
var util = require(&#x27;util&#x27;);
var async = require(&#x27;async&#x27;);
var IpobjModel = require(&#x27;../models/ipobj&#x27;);
var InterfaceModel = require(&#x27;../models/interface&#x27;);
var Interface__ipobjModel = require(&#x27;../models/interface__ipobj&#x27;);
var Ipobj_gModel = require(&#x27;../models/ipobj_g&#x27;);
var Ipobj__ipobjgModel = require(&#x27;../models/ipobj__ipobjg&#x27;);
var FirewallModel = require(&#x27;../models/firewall&#x27;);
var InterfaceModel = require(&#x27;../models/interface&#x27;);
var Policy_rModel = require(&#x27;../models/policy_r&#x27;);
var Policy_r__ipobjModel = require(&#x27;../models/policy_r__ipobj&#x27;);
var Policy_r__interfaceModel = require(&#x27;../models/policy_r__interface&#x27;);

var fs = require(&#x27;fs&#x27;);
var xml2js = require(&#x27;xml2js&#x27;);

/**
* Property Logger to manage App logs
*
* @property logger
* @type log4js/app
* 
*/
var logger = require(&#x27;log4js&#x27;).getLogger(&quot;app&quot;);

router.get(&#x27;/foo&#x27;, function (req, res)
{
    var parser = new xml2js.Parser();
    fs.readFile(__dirname + &#x27;/xml/foo.xml&#x27;, function (error, data) {
        if (error) {
            logger.debug(error);
        } else {
            parser.parseString(data, function (err, result) {
                console.dir(result);
                logger.debug(&#x27;Done&#x27;);
            });
        }
    });

});

router.get(&#x27;/importfirewalls/:iduser/fwcloud/:fwcloud/library/:library&#x27;, function (req, res)
{
    var parser = new xml2js.Parser();
    var fwcloud = null;
    var fwc_file = &quot;&quot;;

    var library = req.params.library.toUpperCase();
    var iduser = req.params.iduser;
    var searchlibrary = &quot;&quot;;
    logger.debug(&quot;READING LIBRARY: &quot; + library);

    if (library === &quot;STANDARD&quot;) {
        fwcloud = null;
        fwc_file = &quot;/xml/FW-TEST_STANDAR.fwb&quot;;
        searchlibrary = &quot;Standard&quot;;
    } else if (library === &quot;USER&quot;) {
        fwcloud = 1;
        fwc_file = &quot;/xml/FW-TEST_USER.fwb&quot;;
        searchlibrary = &quot;User&quot;;
    }

    fs.readFile(__dirname + fwc_file, function (error, data) {
        if (error) {
            logger.debug(error);
            res.status(500).json( {&quot;error&quot;: error});
        } else {
            parser.parseString(data, function (err, result) {

                try {
                    var jsonstr = JSON.stringify(result);
                    var obj = JSON.parse(jsonstr);
                } catch (e) {
                    logger.debug(e);
                }

                try {
                    var row;
                    //Buscamos libreria 
                    var library;
                    SearchNode(obj.FWObjectDatabase.Library, searchlibrary, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO Library : &quot; + row.$.name);
                        library = row;
                    });

                } catch (e) {
                    logger.debug(&quot;ERROR : &quot; + e);
                }

                //ObjectGroup - Firewall
                try {
                    var rows;
                    SearchNode(library.ObjectGroup, &quot;Firewalls&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[0].IPv4;
                    var i = 0;
                    async.forEach(rows.Firewall,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo FIREWALL :&quot; + i + &quot; - &quot; + row.$.name);
                                AddFirewall(iduser, row.$, fwcloud, function (error, data) {
                                    if (error)
                                        logger.debug(&quot;ERROR Añadiendo Firewall : &quot; + error);
                                    else {
                                        logger.debug(&quot;Añadido Firewall con ID: &quot; + data.insertId);
                                        var idfirewall = data.insertId;

                                        //añadimos Interfaces
                                        //ObjectGroup - Interface
                                        try {
                                            var i = 0;
                                            async.forEach(row.Interface,
                                                    function (rowI, callback) {
                                                        i++;
                                                        logger.debug(&quot;Añadiendo OBJETO Interface:&quot; + i + &quot; - &quot; + rowI.$.name);
                                                        AddInterfaceFw(idfirewall, rowI.$, function (error, data) {
                                                            if (error)
                                                                logger.debug(&quot;ERROR Añadiendo Interface : &quot; + error);
                                                            else {
                                                                logger.debug(&quot;Añadido Interface con ID: &quot; + data.insertId);
                                                                var idinterface = data.insertId;
                                                                //Añadimos OBJECTS IP de Interface
                                                                async.forEach(rowI.IPv4,
                                                                        function (rowIP, callback) {
                                                                            logger.debug(&quot;Añadiendo OBJETO Address:&quot; + rowIP.$.name);
                                                                            AddIpobjectAddress(rowIP.$, 5, &#x27;IPv4&#x27;, idinterface, fwcloud);
                                                                        }
                                                                );
                                                            }

                                                        });
                                                    }
                                            );
                                        } catch (e) {
                                            logger.debug(&quot;ERROR Objects Interface: &quot; + e);
                                        }

                                        //añadimos NAT
                                        //ObjectGroup - NAT - NATRule
                                        try {
                                            var n = 0;
                                            var NATGroup = row.NAT[0];
                                            async.forEach(NATGroup.NATRule,
                                                    function (rowNR, callback1) {
                                                        n++;
                                                        logger.debug(&quot;Añadiendo NAT RULE:&quot; + n + &quot; - &quot; + rowNR.$.id);
                                                        AddPolicyRule(idfirewall, rowNR.$, &quot;N&quot;, function (error, data) {
                                                            if (data &amp;&amp; data.length &gt; 0)
                                                            {
                                                                logger.debug(&quot;Añadido NATRule con ID: &quot; + data.insertId);
                                                                var idPolicy = data.insertId;
                                                                //Añadimos Objetos de Regla NAT
                                                                AddPolicyObj(idPolicy, rowNR.OSrc, 11, &quot;O&quot;);
                                                                AddPolicyObj(idPolicy, rowNR.ODst, 12, &quot;O&quot;);
                                                                AddPolicyObj(idPolicy, rowNR.OSrv, 13, &quot;S&quot;);
                                                                AddPolicyObj(idPolicy, rowNR.TSrc, 14, &quot;O&quot;);
                                                                AddPolicyObj(idPolicy, rowNR.TDst, 15, &quot;O&quot;);
                                                                AddPolicyObj(idPolicy, rowNR.TSrv, 16, &quot;S&quot;);
                                                                AddPolicyInterface(idfirewall, idPolicy, rowNR.ItfInb, 23);
                                                                AddPolicyInterface(idfirewall, idPolicy, rowNR.ItfOutb, 24);
                                                                
                                                                AddPolicyObj(idPolicy, rowNR.ItfInb, 23, &quot;O&quot;);
                                                                AddPolicyObj(idPolicy, rowNR.ItfOutb, 24, &quot;O&quot;);
                                                            } else
                                                                logger.debug(&quot;ERROR Añadiendo NATRule : &quot; + error);

                                                        });
                                                    }
                                            );
                                        } catch (e) {
                                            logger.debug(&quot;ERROR NAT RULES: &quot; + e);
                                        }

                                        //añadimos POLICY
                                        //ObjectGroup - Policy - PolicyRule
                                        try {
                                            var n = 0;
                                            var PolicyGroup = row.Policy[0];
                                            async.forEach(PolicyGroup.PolicyRule,
                                                    function (rowPR, callback2) {
                                                        n++;
                                                        var rule_type = &#x27;&#x27;;
                                                        var position = [];
                                                        var position_ref = [];

                                                        logger.debug(&quot;Añadiendo POLICY RULE:&quot; + n + &quot; - &quot; + rowPR.$.id + &quot; - DIRECTION: &quot; + rowPR.$.direction);
                                                        switch (rowPR.$.direction) {
                                                            case &quot;Outbound&quot;:
                                                                rule_type = &#x27;O&#x27;;
                                                                position = [4, 5, 6, 21];
                                                                break;
                                                            case &quot;Inbound&quot;:
                                                                rule_type = &#x27;I&#x27;;
                                                                position = [1, 2, 3, 20];
                                                                break;
                                                            case &quot;Both&quot;:
                                                                rule_type = &#x27;F&#x27;;
                                                                position = [7, 8, 9, 22];
                                                                break;
                                                        }
                                                        AddPolicyRule(idfirewall, rowPR.$, rule_type, function (error, data) {
                                                            if (data &amp;&amp; data.length &gt; 0)
                                                            {
                                                                logger.debug(&quot;Añadido POLICY RULE con ID: &quot; + data.insertId + &quot;   REF: &quot; + rowPR.$.id);
                                                                var idPolicy = data.insertId;
                                                                //Añadimos Objetos de Regla 
                                                                AddPolicyObj(idPolicy, rowPR.Src, position[0], &quot;O&quot;);
                                                                AddPolicyObj(idPolicy, rowPR.Dst, position[1], &quot;O&quot;);
                                                                AddPolicyObj(idPolicy, rowPR.Srv, position[2], &quot;S&quot;);
                                                                AddPolicyInterface(idfirewall, idPolicy, rowPR.Itf, position[3]);
                                                            } else {
                                                                logger.debug(&quot;ERROR Añadiendo POLICY RULE : &quot; + error);
                                                            }

                                                        });
                                                    }
                                            );
                                        } catch (e) {
                                            logger.debug(&quot;ERROR NAT RULES: &quot; + e);
                                        }



                                    }
                                });
                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Objects FIREWALL: &quot; + e);
                }

                res.status(200).json( {&quot;data&quot;: result});
            });
        }
    });


});


/* New firewall */
function AddFirewall(iduser, row, fwcloud, callback)
{
    var firewallData = {
        id: null,
        cluster: null,
        fwcloud: fwcloud,
        name: row.name,
        comment: row.comment,
        id_fwb: row.id
    };

    FirewallModel.insertFirewall(iduser, firewallData, function (error, data)
    {
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT OK InsertId: &quot; + data.insertId);
            callback(null, {&quot;insertId&quot;: data.insertId});
        } else
        {
            callback(error, null);
        }
    });
}

/* Create New interface */
function AddInterfaceFw(idfirewall, row, callback)
{
    //Create New objet with data interface
    var interfaceData = {
        id: null,
        firewall: idfirewall,
        name: row.name,
        labelName: row.label,
        type: &#x27;&#x27;,
        securityLevel: row.security_level,
        comment: row.comment,
        interface_type: 10,
        id_fwb: row.id
    };
    //Set type 
    if (row.unnum === &quot;True&quot;)
        interfaceData.type = &quot;Unnumbered&quot;;
    else if (row.unprotected === &quot;True&quot;)
        interfaceData.type = &quot;Unprotected&quot;;

    InterfaceModel.insertInterface(interfaceData, function (error, data)
    {
        //If saved interface Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT Interface OK InsertId: &quot; + data.insertId);
            callback(null, {&quot;insertId&quot;: data.insertId});
        } else
        {
            callback(error, null);
        }
    });
}

/* Create New policy_r */
function AddPolicyRule(idfirewall, row, type, callback)
{
    switch (row.action) {
        case &quot;Continue&quot;:
            action = 5;
            break;
        case &quot;Accept&quot;:
            action = 1;
            break;
        case &quot;Deny&quot;:
            action = 2;
            break;
        case &quot;Reject&quot;:
            action = 3;
            break;
        case &quot;Translate&quot;:
            action = 4;
            break;
        default:
            action = 1;
            break;
    }

    //Create New objet with data policy_r
    var policy_rData = {
        id: null,
        idgroup: null,
        firewall: idfirewall,
        rule_order: row.position,
        direction: null,
        action: action,
        time_start: null,
        time_end: null,
        active: 1,
        options: null,
        comment: row.comment,
        type: type,
        fw_ref: row.id
    };
    if (row.disabled === &quot;True&quot;)
        policy_rData.active = 0;


    Policy_rModel.insertPolicy_r(policy_rData, function (error, data)
    {
        //If saved policy_r Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT PolicyRule OK InsertId: &quot; + data.insertId + &quot;  TYPE: &quot; + type);
            callback(null, {&quot;insertId&quot;: data.insertId});
        } else
        {
            callback(error, null);
        }
    });
}


/* Create New policy_r__ipobj */
function AddPolicyObj(idPolicy, row, position, typeObj)
{
    var n = 0;
    var obj = row[0];
    var negate = ((obj.$.neg === &#x27;True&#x27;) ? 1 : 0);
    var objRef;
    if (typeObj === &quot;O&quot;)
        objRef = obj.ObjectRef;
    else
        objRef = obj.ServiceRef;


    async.forEach(objRef,
            function (rowRef, callback) {
                n++;
                var ref = rowRef.$.ref;
                logger.debug(&quot;BUSCANDO OBJREF: &quot; + ref);

                IpobjModel.getIpobj_fwb(ref, function (error, data) {
                    if (data[0] &amp;&amp; data[0].id) {
                        var idobj = data[0].id;
                        logger.debug(&quot;ENCONTRADO IPOBJ: &quot; + idobj);
                        //Create New objet with data policy_r__ipobj
                        var policy_r__ipobjData = {
                            rule: idPolicy,
                            ipobj: idobj,
                            ipobj_g: 0,
                            interface: 0,
                            position: position,
                            position_order: n
                        };

                        Policy_r__ipobjModel.insertPolicy_r__ipobj(policy_r__ipobjData, negate, function (error, data)
                        {
                            //If saved policy_r__ipobj Get data
                            if (data &amp;&amp; data.result)
                            {
                                logger.debug(&quot;INSERT PolicyRule_IPObj OK : &quot; + idPolicy + &quot; - &quot; + idobj);
                                callback(null, {&quot;msg&quot;: data.msg});
                            } else
                            {
                                logger.debug(&quot;-----&gt; ERROR INSERT PolicyRule_IPObj : &quot; + idPolicy + &quot; - &quot; + idobj + &quot;  ERROR: &quot; + error);
                                callback(error, null);
                            }
                        });
                    } else {
                        logger.debug(&quot;NO ECONTRADO REF : &quot; + ref);
                    }
                });
            });

}

/* Create New policy_r__interface */
function AddPolicyInterface(idfirewall, idPolicy, row, position)
{
    var n = 0;
    var obj = row[0];
    var negate = ((obj.$.neg === &#x27;True&#x27;) ? 1 : 0);

    var objRef = obj.ObjectRef;


    async.forEach(objRef,
            function (rowRef, callback) {
                n++;
                var ref = rowRef.$.ref;
                logger.debug(&quot;BUSCANDO INTERFACE REF: &quot; + ref);

                InterfaceModel.getInterface_fwb(idfirewall, ref, function (error, data) {
                    if (data[0] &amp;&amp; data[0].id) {
                        var idItf = data[0].id;
                        logger.debug(&quot;ENCONTRADO INTERFACE: &quot; + ref);
                        var policy_r__interfaceData = {
                            rule: idPolicy,
                            interface: idItf,
                            interface_order: 1,
                            negate: negate,
                            position: position,
                            position_order: 1
                        };




                        Policy_r__interfaceModel.insertPolicy_r__interface(policy_r__interfaceData, function (error, data)
                        {
                            //If saved policy_r__interface Get data
                            if (data &amp;&amp; data.result)
                            {
                                logger.debug(&quot;INSERT PolicyRule_INTERFACE OK : &quot; + idPolicy + &quot; - &quot; + ref);
                                callback(null, {&quot;msg&quot;: data.msg});
                            } else
                            {
                                logger.debug(&quot;-----&gt; ERROR INSERT PolicyRule_INTERFACE : &quot; + idPolicy + &quot; - &quot; + ref + &quot;  ERROR: &quot; + error);
                                callback(error, null);
                            }
                        });
                        
                    } else {
                        logger.debug(&quot;NO ECONTRADO INTERFACE REF : &quot; + ref);
                    }
                });
            });

}


router.get(&#x27;/importobj/:library&#x27;, function (req, res)
{
    var parser = new xml2js.Parser();
    var fwcloud = null;
    var fwc_file = &quot;&quot;;

    var library = req.params.library.toUpperCase();
    var searchlibrary = &quot;&quot;;
    logger.debug(&quot;READING LIBRARY: &quot; + library);

    if (library === &quot;STANDARD&quot;) {
        fwcloud = null;
        fwc_file = &quot;/xml/FW-TEST_STANDAR.fwb&quot;;
        searchlibrary = &quot;Standard&quot;;
    } else if (library === &quot;USER&quot;) {
        fwcloud = 1;
        fwc_file = &quot;/xml/FW-TEST_USER.fwb&quot;;
        searchlibrary = &quot;User&quot;;
    }

    fs.readFile(__dirname + fwc_file, function (error, data) {
        if (error) {
            logger.debug(error);
            res.status(500).json( {&quot;error&quot;: error});
        } else {
            parser.parseString(data, function (err, result) {


                //KK  logger.debug(util.inspect(result, false, null));
                logger.debug(&#x27;Done&#x27;);
                try {
                    var jsonstr = JSON.stringify(result);
                    var obj = JSON.parse(jsonstr);
                } catch (e) {
                    logger.debug(e);
                }

                //logger.debug(obj);
                //logger.debug(&quot;DATOS OBJ&quot;);
                //logger.debug(util.inspect(obj.FWObjectDatabase.Library[0].AnyNetwork[0].$.id, false, null));

                try {
                    var row;
                    //Buscamos libreria
                    var library;
                    SearchNode(obj.FWObjectDatabase.Library, searchlibrary, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO Library : &quot; + row.$.name);
                        library = row;
                    }
                    );

                    //añadimos objetos ANY                    
                    logger.debug(&quot;Añadiendo OBJETO ANYNETWORK: &quot; + library.AnyNetwork[0].$.name);
                    AddIpobjectAddress(library.AnyNetwork[0].$, 5, &#x27;&#x27;, null, fwcloud);

                    logger.debug(&quot;Añadiendo OBJETO ANYSERVICE: &quot; + library.AnyIPService[0].$.name);
                    AddServiceIP(library.AnyIPService[0].$, 1, fwcloud);

                    logger.debug(&quot;Añadiendo OBJETO ANYINTERVAL: &quot; + library.AnyInterval[0].$.name);
                    //KK AddServiceIP(library.AnyIPService.$, 1, fwcloud);

                    var objectsGroup;
                    //Buscamos Grupo Objects
                    SearchNode(library.ObjectGroup, &quot;Objects&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        objectsGroup = row;
                    }
                    );

                } catch (e) {
                    logger.debug(&quot;ERROR : &quot; + e);
                }

                //ObjectGroup - Addresses
                try {
                    var rows;
                    SearchNode(objectsGroup.ObjectGroup, &quot;Addresses&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[0].IPv4;
                    var i = 0;
                    async.forEach(rows.IPv4,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo OBJETO Address:&quot; + i + &quot; - &quot; + row.$.name);
                                AddIpobjectAddress(row.$, 5, &#x27;&#x27;, null, fwcloud);
                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Objects Address: &quot; + e);
                }

                //ObjectGroup - Addresses Ranges 
                try {
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[6].AddressRange;
                    var rows;
                    SearchNode(objectsGroup.ObjectGroup, &quot;Address Ranges&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    var i = 0;
                    async.forEach(rows.AddressRange,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo OBJETO Address Range:&quot; + i + &quot; - &quot; + row.$.name);
                                AddIpobjectAddressRanges(row.$, 6, null, fwcloud);
                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Objects Address Ranges: &quot; + e);
                }

                //ObjectGroup - Networks 
                try {

                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[5].Network;
                    var rows;
                    SearchNode(objectsGroup.ObjectGroup, &quot;Networks&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    var i = 0;
                    async.forEach(rows.Network,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo OBJETO Network:&quot; + i + &quot; - &quot; + row.$.name);
                                AddIpobjectAddress(row.$, 7, &#x27;IPv4&#x27;, null, fwcloud);
                            }
                    );

                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[5].NetworkIPv6;
                    var i = 0;
                    async.forEach(rows.NetworkIPv6,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo OBJETO NetworkIPV6:&quot; + i + &quot; - &quot; + row.$.name);
                                AddIpobjectAddress(row.$, 7, &#x27;IPv6&#x27;, null, fwcloud);
                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Objects Network: &quot; + e);
                }

                //ObjectGroup - Hosts
                try {
                    //logger.debug(util.inspect(obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[4].Host, false, null));
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[4].Host;
                    var rows;
                    SearchNode(objectsGroup.ObjectGroup, &quot;Hosts&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    var i = 0;
                    async.forEach(rows.Host,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo OBJETO HOST:&quot; + i + &quot; - &quot; + row.$.name);
                                AddIpobject(row.$, 8, fwcloud, function (error, data) {
                                    if (error)
                                        logger.debug(&quot;ERROR Añadiendo host&quot;);
                                    else {
                                        logger.debug(&quot;Añadido host con ID: &quot; + data.insertId);
                                        var idhost = data.insertId;
                                        //Add Interface
                                        //FALTA BUCLE por INTERFACES
                                        var rowI = row.Interface[0];
                                        logger.debug(rowI);
                                        AddInterfaceHost(rowI.$, 11, idhost, function (error, data) {
                                            if (error)
                                                logger.debug(&quot;ERROR Añadiendo Interface de  host: &quot; + error);
                                            else {
                                                logger.debug(&quot;Añadido Interface con ID: &quot; + data.insertId);
                                                var id_interface = data.insertId;
                                                //Add Host&lt;-&gt;Interface relationship
                                                AddInterfaceHost_Relation(id_interface, idhost, 1, function (error, data) {
                                                    if (error)
                                                        logger.debug(&quot;ERROR Añadiendo Interface&lt;-&gt;host: &quot; + error);
                                                    else
                                                        logger.debug(&quot;Añadido Interface&lt;-&gt;host: &quot; + data.msg);
                                                });
                                                //Add IP Address 
                                                var rowIP = rowI.IPv4[0];
                                                AddIpobjectAddress(rowIP.$, 5, &#x27;IPv4&#x27;, id_interface, fwcloud);
                                            }

                                        });


                                        //Interface Options
                                    }
                                });

                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Objects Host: &quot; + e);
                }

                //ObjectGroup - GROUPS
                try {
                    //logger.debug(util.inspect(obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[3].ObjectGroup, false, null));
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[3].ObjectGroup;
                    var rows;
                    SearchNode(objectsGroup.ObjectGroup, &quot;Groups&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    var i = 0;
                    async.forEach(rows.ObjectGroup,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo OBJETO GROUP:&quot; + i + &quot; - &quot; + row.$.name);
                                AddGroup(row.$, 20, fwcloud, function (error, data) {
                                    if (error) {
                                        logger.debug(&quot;ERROR Añadiendo GROUP: &quot; + error);
                                    } else {
                                        logger.debug(&quot;Añadido GROUP con ID: &quot; + data.insertId);
                                        var idgroup = data.insertId;
                                        var rowsR = row.ObjectRef;
                                        async.forEach(rowsR,
                                                function (rowR, callback) {
                                                    logger.debug(&quot;Añadiendo OBJETO de Grupo :&quot; + idgroup + &quot;   objref: &quot; + rowR.$.ref);
                                                    AddGroupObj(idgroup, rowR.$.ref);
                                                });

                                    }
                                });

                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Objects Address: &quot; + e);
                }



                //READ SERVICE OBJECTS
                var ServicesGroup;
                //Buscamos Grupo Services
                SearchNode(library.ServiceGroup, &quot;Services&quot;, function (row) {
                    logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                    ServicesGroup = row;
                }
                );

                //ServiceGroup - IP
                try {
                    var rows;
                    SearchNode(ServicesGroup.ServiceGroup, &quot;IP&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[0].IPv4;
                    var i = 0;
                    async.forEach(rows.IPService,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo SERVICE IP:&quot; + i + &quot; - &quot; + row.$.name);
                                AddServiceIP(row.$, 1, fwcloud);
                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Service IP: &quot; + e);
                }

                //ServiceGroup - TCP
                try {
                    var rows;
                    SearchNode(ServicesGroup.ServiceGroup, &quot;TCP&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[0].IPv4;
                    var i = 0;
                    async.forEach(rows.TCPService,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo SERVICE TCP:&quot; + i + &quot; - &quot; + row.$.name);
                                AddServiceTCP(row.$, 2, fwcloud);
                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Service TCP: &quot; + e);
                }

                //ServiceGroup - UDP
                try {
                    var rows;
                    SearchNode(ServicesGroup.ServiceGroup, &quot;UDP&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[0].IPv4;
                    var i = 0;
                    async.forEach(rows.UDPService,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo SERVICE UDP:&quot; + i + &quot; - &quot; + row.$.name);
                                AddServiceUDP(row.$, 4, fwcloud);
                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Service UDP: &quot; + e);
                }

                //ServiceGroup - ICMP
                try {
                    var rows;
                    SearchNode(ServicesGroup.ServiceGroup, &quot;ICMP&quot;, function (row) {
                        logger.debug(&quot;-------&gt; DEVUELTO GRUPO : &quot; + row.$.name);
                        rows = row;
                    });
                    //var rows = obj.FWObjectDatabase.Library[0].ObjectGroup[0].ObjectGroup[0].IPv4;
                    var i = 0;
                    async.forEach(rows.ICMPService,
                            function (row, callback) {
                                i++;
                                logger.debug(&quot;Añadiendo SERVICE ICMP:&quot; + i + &quot; - &quot; + row.$.name);
                                AddServiceICMP(row.$, 3, fwcloud);
                            }
                    );
                } catch (e) {
                    logger.debug(&quot;ERROR Service ICMP: &quot; + e);
                }



                res.status(200).json( {&quot;data&quot;: result});
            });
        }
    });
});


function SearchNodeSync(rows, searchname, callback) {
    logger.debug(&quot;DENTRO de SEARCHNODE&quot;);
    //Buscamos Grupo
    async.forEach(rows,
            function (row, foundcall) {
                logger.debug(&quot;ESTAMOS en GRUPO: &quot; + row.$.name);
                if (row.$.name === searchname) {
                    logger.debug(&quot;ENCONTRADO GRUPO: &quot; + row.$.name);
                    return foundcall(row);
                }
                foundcall();
            },
            function (rowfound) {
                return callback(rowfound);
            }
    );

}
function SearchNode(rows, searchname, callback) {

    //Buscamos Grupo
    var n = rows.length;
    for (i = 0; i &lt; n; i++) {
        var name = rows[i].$.name.toUpperCase();
        var sname = searchname.toUpperCase();
        logger.debug(&quot;ESTAMOS en GRUPO: &quot; + name + &quot; -&gt; comparando con : &quot; + sname);
        if (name === sname) {
            logger.debug(&quot;ENCONTRADO GRUPO: &quot; + rows[i].$.name);
            return callback(rows[i]);
        }
    }
}




function AddIpobject(row, obj_type, fwcloud, callback) {
    //Create New objet with data ipobj    
    var ipobjData = {
        id: null,
        fwcloud: fwcloud,
        interface: null,
        name: row.name,
        type: obj_type,
        protocol: null,
        address: null,
        netmask: null,
        diff_serv: null,
        ip_version: null,
        code: null,
        tcp_flags_mask: null,
        tcp_flags_settings: null,
        range_start: null,
        range_end: null,
        source_port_start: null,
        source_port_end: null,
        destination_port_start: null,
        destination_port_end: null,
        options: null,
        comment: row.comment,
        id_fwb: row.id
    };

    IpobjModel.insertIpobj(ipobjData, function (error, data)
    {
        //If saved ipobj Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT OK InsertId: &quot; + data.insertId);
            callback(null, {&quot;insertId&quot;: data.insertId});

        } else
        {
            logger.debug(&quot;ERROR INSERT insertIpobj: &quot; + error);
            callback(error, null);
        }
    });

}

/* Create New interface */
function AddInterfaceHost(row, type, idhost, callback)
{
    //Create New objet with data interface
    var interfaceData = {
        id: null,
        firewall: null,
        name: row.name,
        labelName: row.name,
        type: type,
        securityLevel: row.security_level,
        interface_type: type,
        id_fwb: row.id
    };

    InterfaceModel.insertInterface(interfaceData, function (error, data)
    {
        //If saved interface Get data
        if (data &amp;&amp; data.insertId)
        {
            callback(null, {&quot;insertId&quot;: data.insertId});
        } else
        {
            callback(error, null);
        }
    });
}

/* Create New interface__ipobj */
function AddInterfaceHost_Relation(id_interface, id_ipobj, order, callback)
{
    //Create New objet with data interface__ipobj
    var interface__ipobjData = {
        interface: id_interface,
        ipobj: id_ipobj,
        interface_order: order
    };

    Interface__ipobjModel.insertInterface__ipobj(interface__ipobjData, function (error, data)
    {
        //If saved interface__ipobj Get data
        if (data &amp;&amp; data.result)
        {
            callback(null, {&quot;msg&quot;: data.msg});
        } else
        {
            callback(error, null);
        }
    });
}

function AddIpobjectAddress(row, obj_type, ipversion, id_interface, fwcloud) {
    //Create New objet with data ipobj    
    var ipobjData = {
        id: null,
        fwcloud: fwcloud,
        interface: id_interface,
        name: row.name,
        type: obj_type,
        protocol: null,
        address: row.address,
        netmask: row.netmask,
        diff_serv: null,
        ip_version: ipversion,
        code: null,
        tcp_flags_mask: null,
        tcp_flags_settings: null,
        range_start: null,
        range_end: null,
        source_port_start: null,
        source_port_end: null,
        destination_port_start: null,
        destination_port_end: null,
        options: null,
        comment: row.comment,
        id_fwb: row.id
    };

    IpobjModel.insertIpobj(ipobjData, function (error, data)
    {
        //If saved ipobj Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT IpobjectAddress OK InsertId: &quot; + data.insertId);

        } else
        {
            logger.debug(&quot;ERROR IpobjectAddress INSERT insertIpobj: &quot; + error);
        }
    });

}

function AddIpobjectAddressRanges(row, obj_type, fwcloud) {
    //Create New objet with data ipobj    
    var ipobjData = {
        id: null,
        fwcloud: fwcloud,
        interface: null,
        name: row.name,
        type: obj_type,
        protocol: null,
        address: null,
        netmask: null,
        diff_serv: null,
        ip_version: null,
        code: null,
        tcp_flags_mask: null,
        tcp_flags_settings: null,
        range_start: row.start_address,
        range_end: row.end_address,
        source_port_start: null,
        source_port_end: null,
        destination_port_start: null,
        destination_port_end: null,
        options: null,
        comment: row.comment,
        id_fwb: row.id
    };

    IpobjModel.insertIpobj(ipobjData, function (error, data)
    {
        //If saved ipobj Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT OK InsertId: &quot; + data.insertId);

        } else
        {
            logger.debug(&quot;ERROR INSERT insertIpobj: &quot; + error);
        }
    });

}

/* Create New ipobj_g */
function AddGroup(row, type, fwcloud, callback)
{
    //Create New objet with data ipobj_g
    var ipobj_gData = {
        id: null,
        name: row.name,
        type: type,
        fwcloud: fwcloud,
        id_fwb: row.id
    };

    Ipobj_gModel.insertIpobj_g(ipobj_gData, function (error, data)
    {
        //If saved ipobj_g Get data
        if (data &amp;&amp; data.insertId)
        {
            callback(null, {&quot;insertId&quot;: data.insertId});
        } else
        {
            callback(error, null);
        }
    });
}

/* Create New ipobj_g */
function AddGroupObj(idgroup, objref)
{
    Ipobj__ipobjgModel.insertIpobj__ipobjg_objref(idgroup, objref, function (error, result)
    {
        //If saved ipobj_g Get data
        if (result)
        {
            logger.debug(&quot;INSERT OK : &quot; + result.msg);
        } else
        {
            logger.debug(&quot;ERROR INSERT insertIpobj__ipobjg_objref: &quot; + error);
        }
    });
}

function AddServiceIP(row, obj_type, fwcloud) {
    //Create New objet with data ipobj    
    var ipobjData = {
        id: null,
        fwcloud: fwcloud,
        interface: null,
        name: row.name,
        type: obj_type,
        protocol: row.protocol_num,
        address: null,
        netmask: null,
        diff_serv: 2,
        ip_version: null,
        code: null,
        tcp_flags_mask: null,
        tcp_flags_settings: null,
        range_start: null,
        range_end: null,
        source_port_start: null,
        source_port_end: null,
        destination_port_start: null,
        destination_port_end: null,
        options: null,
        comment: row.comment,
        id_fwb: row.id
    };

    IpobjModel.insertIpobj(ipobjData, function (error, data)
    {
        //If saved ipobj Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT OK IP Service InsertId: &quot; + data.insertId);
        } else
        {
            logger.debug(&quot;ERROR INSERT IP Service: &quot; + error);
        }
    });

}
function AddServiceTCP(row, obj_type, fwcloud) {
    //Create New objet with data ipobj    
    var ipobjData = {
        id: null,
        fwcloud: fwcloud,
        interface: null,
        name: row.name,
        type: obj_type,
        protocol: null,
        address: null,
        netmask: null,
        diff_serv: 2,
        ip_version: null,
        code: null,
        tcp_flags_mask: null,
        tcp_flags_settings: null,
        range_start: null,
        range_end: null,
        source_port_start: row.src_range_start,
        source_port_end: row.src_range_end,
        destination_port_start: row.dst_range_start,
        destination_port_end: row.dst_range_end,
        options: null,
        comment: row.comment,
        id_fwb: row.id
    };

    IpobjModel.insertIpobj(ipobjData, function (error, data)
    {
        //If saved ipobj Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT OK TCP Service InsertId: &quot; + data.insertId);
        } else
        {
            logger.debug(&quot;ERROR INSERT TCP Service : &quot; + error);
        }
    });

}

function AddServiceUDP(row, obj_type, fwcloud) {
    //Create New objet with data ipobj    
    var ipobjData = {
        id: null,
        fwcloud: fwcloud,
        interface: null,
        name: row.name,
        type: obj_type,
        protocol: null,
        address: null,
        netmask: null,
        diff_serv: null,
        ip_version: null,
        code: null,
        tcp_flags_mask: null,
        tcp_flags_settings: null,
        range_start: null,
        range_end: null,
        source_port_start: row.src_range_start,
        source_port_end: row.src_range_end,
        destination_port_start: row.dst_range_start,
        destination_port_end: row.dst_range_end,
        options: null,
        comment: row.comment,
        id_fwb: row.id
    };

    IpobjModel.insertIpobj(ipobjData, function (error, data)
    {
        //If saved ipobj Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT OK UDP Service InsertId: &quot; + data.insertId);
        } else
        {
            logger.debug(&quot;ERROR INSERT UDP Service : &quot; + error);
        }
    });

}

function AddServiceICMP(row, obj_type, fwcloud) {
    //Create New objet with data ipobj    
    //FALTA TYPE ICMP
    var ipobjData = {
        id: null,
        fwcloud: fwcloud,
        interface: null,
        name: row.name,
        type: obj_type,
        protocol: null,
        address: null,
        netmask: null,
        diff_serv: null,
        ip_version: null,
        code: row.code,
        tcp_flags_mask: null,
        tcp_flags_settings: null,
        range_start: null,
        range_end: null,
        source_port_start: null,
        source_port_end: null,
        destination_port_start: null,
        destination_port_end: null,
        options: null,
        comment: row.comment,
        id_fwb: row.id
    };

    IpobjModel.insertIpobj(ipobjData, function (error, data)
    {
        //If saved ipobj Get data
        if (data &amp;&amp; data.insertId)
        {
            logger.debug(&quot;INSERT OK ICMP Service InsertId: &quot; + data.insertId);
        } else
        {
            logger.debug(&quot;ERROR INSERT ICMP Service : &quot; + error);
        }
    });

}

module.exports = router;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
