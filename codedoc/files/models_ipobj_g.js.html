<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>models/ipobj_g.js - FWCloud API REST Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://foswiki.soltecsis.com/codedoc/soltecsis-logo1.png" title="FWCloud API REST Documentation"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ClusterRouter.html">ClusterRouter</a></li>
                                <li><a href="../classes/FirewallModel.html">FirewallModel</a></li>
                                <li><a href="../classes/FirewallRouter.html">FirewallRouter</a></li>
                                <li><a href="../classes/IpobjsRouter.html">IpobjsRouter</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/ClusterRouter.html">ClusterRouter</a></li>
                                <li><a href="../modules/FirewallModel.html">FirewallModel</a></li>
                                <li><a href="../modules/FirewallRouter.html">FirewallRouter</a></li>
                                <li><a href="../modules/IpobjsRouter.html">IpobjsRouter</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: models/ipobj_g.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var db = require(&#x27;../db.js&#x27;);
//var Ipobj__ipobjgModel = require(&#x27;../models/ipobj__ipobjg&#x27;);
var IpobjModel = require(&#x27;../models/ipobj&#x27;);
var async = require(&#x27;async&#x27;);
var ipobj_g_Data = require(&#x27;../models/data_ipobj_g&#x27;);
var ipobj_Data = require(&#x27;../models/data_ipobj&#x27;);
var Policy_r__ipobjModel = require(&#x27;../models/policy_r__ipobj&#x27;);
var Ipobj__ipobjgModel = require(&#x27;../models/ipobj__ipobjg&#x27;);

//create object
var ipobj_gModel = {};
var tableModel = &quot;ipobj_g&quot;;

/**
 * Property Logger to manage App logs
 *
 * @property logger
 * @type log4js/app
 * 
 */
var logger = require(&#x27;log4js&#x27;).getLogger(&quot;app&quot;);

//Get All ipobj_g
ipobj_gModel.getIpobj_gs = function (fwcloud, callback) {

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        connection.query(&#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE (fwcloud= &#x27; + connection.escape(fwcloud) + &#x27;  OR fwcloud is null) ORDER BY id&#x27;, function (error, rows) {
            if (error)
                callback(error, null);
            else
                callback(null, rows);
        });
    });
};





//Get ipobj_g by  id
ipobj_gModel.getIpobj_g = function (fwcloud, id, callback) {
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE id = &#x27; + connection.escape(id) + &#x27; AND  (fwcloud= &#x27; + connection.escape(fwcloud) + &#x27; OR fwcloud is null) &#x27;;
        connection.query(sql, function (error, row) {
            if (error)
                callback(error, null);
            else {
                callback(null, row);
            }
        });
    });
};

//Get ipobj_g by  id AND ALL IPOBjs
ipobj_gModel.getIpobj_g_Full = function (fwcloud, id, AllDone) {

    var groups = [];
    var group_cont = 0;
    var ipobjs_cont = 0;

    db.get(function (error, connection) {
        if (error)
            callback(error, null);

        var sqlId = &#x27;&#x27;;
        if (id !== &#x27;&#x27;)
            sqlId = &#x27; AND G.id = &#x27; + connection.escape(id);
        var sql = &#x27;SELECT G.*,  T.id id_node, T.id_parent id_parent_node FROM &#x27; + tableModel + &#x27; G &#x27; +
                &#x27;inner join fwc_tree T on T.id_obj=G.id and T.obj_type=G.type AND (T.fwcloud=&#x27; + connection.escape(fwcloud) + &#x27; OR T.fwcloud IS NULL) &#x27; +
                &#x27; WHERE  (G.fwcloud= &#x27; + connection.escape(fwcloud) + &#x27; OR G.fwcloud is null) &#x27; + sqlId;
        //logger.debug(sql);
        connection.query(sql, function (error, rows) {
            if (error)
                callback(error, null);
            else if (rows.length &gt; 0) {
                group_cont = rows.length;
                var row = rows[0];
                async.map(rows, function (row, callback1) {

                    var group_node = new ipobj_g_Data(row);

                    logger.debug(&quot; ---&gt; DENTRO de GRUPO: &quot; + row.id + &quot; NAME: &quot; + row.name);
                    var idgroup = row.id;
                    group_node.ipobjs = new Array();
                    //GET ALL GROUP OBJECTs
                    IpobjModel.getAllIpobjsGroup(fwcloud, idgroup, function (error, data_ipobjs) {
                        if (data_ipobjs.length &gt; 0) {
                            ipobjs_cont = data_ipobjs.length;

                            async.map(data_ipobjs, function (data_ipobj, callback2) {
                                //GET OBJECTS
                                logger.debug(&quot;--&gt; DENTRO de OBJECT id:&quot; + data_ipobj.id + &quot;  Name:&quot; + data_ipobj.name + &quot;  Type:&quot; + data_ipobj.type);

                                var ipobj_node = new ipobj_Data(data_ipobj);
                                //AÃ±adimos ipobj a array Grupo
                                group_node.ipobjs.push(ipobj_node);
                                callback2();
                            }, //Fin de bucle de IPOBJS
                                    function (err) {

                                        if (group_node.ipobjs.length &gt;= ipobjs_cont) {
                                            groups.push(group_node);
                                            if (groups.length &gt;= group_cont) {
                                                AllDone(null, groups);
                                            }


                                        }
                                    }
                            );
                        } else {
                            groups.push(group_node);
                            if (groups.length &gt;= group_cont) {
                                AllDone(null, groups);
                            }
                        }
                    }
                    );
                    callback1();
                }, //Fin de bucle de GROUPS
                        function (err) {
                            if (groups.length &gt;= group_cont) {

                                AllDone(null, groups);
                            }
                        }
                );
            } else {
                AllDone(&quot;&quot;, null);
            }
        });
    });
};
//Get ipobj_g by name
ipobj_gModel.getIpobj_gName = function (fwcloud, name, callback) {
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var namesql = &#x27;%&#x27; + name + &#x27;%&#x27;;
        var sql = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE name like  &#x27; + connection.escape(namesql) + &#x27; AND  fwcloud= &#x27; + connection.escape(fwcloud);
        connection.query(sql, function (error, row) {
            if (error)
                callback(error, null);
            else
                callback(null, row);
        });
    });
};
//Get ipobj_g by  tipo
ipobj_gModel.getIpobj_gType = function (fwcloud, type, callback) {
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE type =  &#x27; + connection.escape(type) + &#x27; AND  fwcloud= &#x27; + connection.escape(fwcloud);
        connection.query(sql, function (error, row) {
            if (error)
                callback(error, null);
            else
                callback(null, row);
        });
    });
};


/* Search where is used GROUP  */
ipobj_gModel.searchGroup = function (id, fwcloud, callback) {
    //SEARCH IPOBJ GROUP IN RULES
    Policy_r__ipobjModel.searchGroupInRule(id, fwcloud, function (error, data_grouprule) {
        if (error) {
            callback(error, null);
        } else {

            if (data_grouprule.found !== &quot;&quot;) {
                callback(null, {&quot;result&quot;: true, &quot;msg&quot;: &quot;GROUP FOUND&quot;, &quot;search&quot;: {
                            &quot;groupInRules&quot;: data_grouprule}});
            } else {
                callback(null, {&quot;result&quot;: false, &quot;msg&quot;: &quot;GROUP NOT FOUND&quot;, &quot;search&quot;: {
                            &quot;groupInRules&quot;: &quot;&quot;}});
            }

        }
    });

};

/* Search where is used GROUP IN RULES AND MEMBERS */
ipobj_gModel.searchGroupInRules = function (id, fwcloud, callback) {
    //SEARCH IPOBJ GROUP IN RULES
    Policy_r__ipobjModel.searchGroupInRule(id, fwcloud, function (error, data_grouprule) {
        if (error) {
            callback(error, null);
        } else {
            //SEARCH IPOBJ GROUP IN RULES
            Policy_r__ipobjModel.searchIpobjInGroupInRule(id, fwcloud, function (error, data_ipobjrule) {
                if (error) {
                    callback(error, null);
                } else {

                    if (data_grouprule.found !== &quot;&quot; || data_ipobjrule.found !== &quot;&quot;) {
                        callback(null, {&quot;result&quot;: true, &quot;msg&quot;: &quot;GROUP FOUND&quot;, &quot;search&quot;: [{
                                    &quot;groupInRules&quot;: data_grouprule, &quot;ipobjInGroupInRules&quot;: data_ipobjrule}]});
                    } else {
                        callback(null, {&quot;result&quot;: false, &quot;msg&quot;: &quot;GROUP NOT FOUND&quot;, &quot;search&quot;: [{
                                    &quot;groupInRules&quot;: &quot;&quot;, &quot;ipobjInGroupInRules&quot;: &quot;&quot;}]});
                    }
                }
            });
        }
    });

};

//Add new ipobj_g
ipobj_gModel.insertIpobj_g = function (ipobj_gData, callback) {
    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        connection.query(&#x27;INSERT INTO &#x27; + tableModel + &#x27; SET ?&#x27;, ipobj_gData, function (error, result) {
            if (error) {
                callback(error, null);
            } else {
                if (result.affectedRows &gt; 0) {
                    //devolvemos la Ãºltima id insertada
                    callback(null, {&quot;insertId&quot;: result.insertId});
                } else
                    callback(error, null);
            }
        });
    });
};
//Update ipobj_g
ipobj_gModel.updateIpobj_g = function (ipobj_gData, callback) {

    db.get(function (error, connection) {
        if (error)
            callback(error, null);
        var sql = &#x27;UPDATE &#x27; + tableModel + &#x27; SET name = &#x27; + connection.escape(ipobj_gData.name) + &#x27; &#x27; +
                &#x27; ,type = &#x27; + connection.escape(ipobj_gData.type) + &#x27; &#x27; +
                &#x27; ,comment = &#x27; + connection.escape(ipobj_gData.comment) + &#x27; &#x27; +
                &#x27; WHERE id = &#x27; + ipobj_gData.id + &#x27; AND fwcloud=&#x27; + connection.escape(ipobj_gData.fwcloud);
        connection.query(sql, function (error, result) {
            if (error) {
                logger.debug(sql);
                logger.debug(error);
                callback(error, null);
            } else {
                callback(null, {&quot;result&quot;: true});
            }
        });
    });
};
//Remove ipobj_g with id to remove
ipobj_gModel.deleteIpobj_g = function (fwcloud, id, type, callback) {
    //CHECK IPOBJ OR GROUP IN RULE
    this.searchGroupInRules(id, fwcloud, function (error, data) {
        if (error) {
            logger.error(error);
            callback(error, null);
        } else {
            //CHECK RESULTS
            if (data.result) {
                logger.debug(&quot;RESTRICTED GROUP: &quot; + id + &quot;  Type: &quot; + type + &quot;  Fwcloud: &quot; + fwcloud);
                callback(null, {&quot;result&quot;: false, &quot;msg&quot;: &quot;Restricted&quot;, &quot;restrictions&quot;: data.search});
            } else {
                db.get(function (error, connection) {
                    if (error)
                        callback(error, null);
                    var sqlExists = &#x27;SELECT * FROM &#x27; + tableModel + &#x27; WHERE id = &#x27; + connection.escape(id) + &#x27; AND fwcloud=&#x27; + connection.escape(fwcloud) + &#x27; AND type=&#x27; + connection.escape(type);
                    connection.query(sqlExists, function (error, row) {
                        //If exists Id from ipobj_g to remove
                        if (row) {
                            db.get(function (error, connection) {
                                //DELETE CHILDREN
                                Ipobj__ipobjgModel.deleteIpobj__ipobjgAll(id, function (error, data) {
                                    if (error) {
                                        logger.error(error);
                                        callback(error, null);
                                    } else {
                                        var sql = &#x27;DELETE FROM &#x27; + tableModel + &#x27; WHERE id = &#x27; + connection.escape(id) + &#x27; AND fwcloud=&#x27; + connection.escape(fwcloud) + &#x27; AND type=&#x27; + connection.escape(type);
                                        connection.query(sql, function (error, result) {
                                            if (error) {
                                                logger.error(error);
                                                callback(error, null);
                                            } else {
                                                if (result.affectedRows &gt; 0)
                                                    callback(null, {&quot;result&quot;: true,&quot;msg&quot;: &quot;deleted&quot;});
                                                else
                                                    callback(null, {&quot;result&quot;: false,&quot;msg&quot;: &quot;notExist&quot;});
                                            }
                                        });
                                    }
                                });
                            });
                        } else {
                            callback(null, {&quot;result&quot;: false,&quot;msg&quot;: &quot;notExist&quot;});
                        }
                    });
                });
            }            
        }
    });

};
//Export the object
module.exports = ipobj_gModel;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
