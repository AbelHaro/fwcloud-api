<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routes/policy/compile.js - FWCloud API REST Documentation</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://foswiki.soltecsis.com/codedoc/soltecsis-logo1.png" title="FWCloud API REST Documentation"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ClusterRouter.html">ClusterRouter</a></li>
                                <li><a href="../classes/CompileRouter.html">CompileRouter</a></li>
                                <li><a href="../classes/FirewallModel.html">FirewallModel</a></li>
                                <li><a href="../classes/FirewallRouter.html">FirewallRouter</a></li>
                                <li><a href="../classes/FwcloudModel.html">FwcloudModel</a></li>
                                <li><a href="../classes/FwcloudRouter.html">FwcloudRouter</a></li>
                                <li><a href="../classes/IpobjModel.html">IpobjModel</a></li>
                                <li><a href="../classes/IpobjsRouter.html">IpobjsRouter</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Cluster.html">Cluster</a></li>
                                <li><a href="../modules/Compile.html">Compile</a></li>
                                <li><a href="../modules/Firewall.html">Firewall</a></li>
                                <li><a href="../modules/FirewallExport.html">FirewallExport</a></li>
                                <li><a href="../modules/Fwcloud.html">Fwcloud</a></li>
                                <li><a href="../modules/Ipobjs.html">Ipobjs</a></li>
                                <li><a href="../modules/OpenVPN.html">OpenVPN</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: routes/policy/compile.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Module to routing COMPILE requests
 * &lt;br&gt;BASE ROUTE CALL: &lt;b&gt;/policy/compile&lt;/b&gt;
 *
 * @module Compile
 *
 * @requires express
 * @requires Policy_rModel
 *
 */


/**
 * Class to manage Compile Policy
 *
 * @class CompileRouter
 */


/**
 * Property  to manage express
 *
 * @property express
 * @type express
 */
var express = require(&#x27;express&#x27;);
/**
 * Property  to manage  route
 *
 * @property router
 * @type express.Router
 */
var router = express.Router();

/**
 * Property Logger to manage App logs
 *
 * @property logger
 * @type log4js/app
 *
 */
var logger = require(&#x27;log4js&#x27;).getLogger(&quot;compiler&quot;);
/**
 * Property Model to manage API RESPONSE data
 *
 * @property api_resp
 * @type ../../models/api_response
 *
 */
var api_resp = require(&#x27;../../utils/api_response&#x27;);

/**
 * Property Model to manage compilation process
 *
 * @property RuleCompileModel
 * @type ../../models/compile/
 */
var RuleCompile = require(&#x27;../../models/policy/rule_compile&#x27;);

/**
 * Property Model to manage policy script generation and install process
 *
 * @property PolicyScript
 * @type ../../models/compile/
 */
var PolicyScript = require(&#x27;../../models/policy/policy_script&#x27;);

const config = require(&#x27;../../config/config&#x27;);
const FirewallModel = require(&#x27;../../models/firewall/firewall&#x27;);
const socketTools = require(&#x27;../../utils/socket&#x27;);


/*----------------------------------------------------------------------------------------------------------------------*/
/* Compile a firewall rule. */
/*----------------------------------------------------------------------------------------------------------------------*/
router.put(&#x27;/rule&#x27;, async (req, res) =&gt; {
	try {
  	/* The get method of the RuleCompile model returns a promise. */
  	const data = await RuleCompile.get(req.body.fwcloud, req.body.firewall, req.body.type, req.body.rule);
		api_resp.getJson({&quot;result&quot;: true, &quot;cs&quot;: data}, api_resp.ACR_OK, &#x27;&#x27;, &#x27;COMPILE&#x27;, null, jsonResp =&gt; res.status(200).json(jsonResp));
	} catch(error) { api_resp.getJson(error, api_resp.ACR_ERROR, &#x27;&#x27;, &#x27;COMPILE&#x27;, error, jsonResp =&gt; res.status(200).json(jsonResp)) }
});
/*----------------------------------------------------------------------------------------------------------------------*/

/*----------------------------------------------------------------------------------------------------------------------*/
/* Compile a firewall. */
/*----------------------------------------------------------------------------------------------------------------------*/
router.put(&#x27;/&#x27;, (req, res) =&gt; {
	var fs = require(&#x27;fs&#x27;);
	var path = config.get(&#x27;policy&#x27;).data_dir;
	if (!fs.existsSync(path))
		fs.mkdirSync(path);
	path += &quot;/&quot; + req.body.fwcloud;
	if (!fs.existsSync(path))
		fs.mkdirSync(path);
	path += &quot;/&quot; + req.body.firewall;
	if (!fs.existsSync(path))
		fs.mkdirSync(path);
	path += &quot;/&quot; + config.get(&#x27;policy&#x27;).script_name;
	var stream = fs.createWriteStream(path);

	stream.on(&#x27;open&#x27;, async fd =&gt; {
		socketTools.init(req); // Init the socket used for message notification by the socketTools module.

		try {
			/* Generate the policy script. */
			let data = await PolicyScript.append(config.get(&#x27;policy&#x27;).header_file);
			data = await PolicyScript.dumpFirewallOptions(req.body.fwcloud,req.body.firewall,data);
			stream.write(data.cs + &quot;greeting_msg() {\n&quot; +
				&quot;log \&quot;FWCloud.net - Loading firewall policy generated: &quot; + Date() + &quot;\&quot;\n}\n\n&quot; +
				&quot;policy_load() {\n&quot;);
			
			if (data.options &amp; 0x0001) { // Statefull firewall
				stream.write(&quot;# Statefull firewall.\n&quot; +
					&quot;$IPTABLES -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n&quot; +
					&quot;$IPTABLES -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT\n&quot; +
					&quot;$IPTABLES -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT\n&quot;);
				socketTools.msg(&quot;&lt;strong&gt;--- STATEFUL FIREWALL ---&lt;/strong&gt;\n\n&quot;);
			}
			else
				socketTools.msg(&quot;&lt;strong&gt;--- STATELESS FIREWALL ---&lt;/strong&gt;\n\n&quot;);
			
			stream.write(&quot;\n\necho -e \&quot;\\nINPUT TABLE\\n-----------\&quot;\n&quot;);
			socketTools.msg(&quot;&lt;strong&gt;INPUT TABLE:&lt;/strong&gt;\n&quot;);

			let cs = await PolicyScript.dump(req,1);
			stream.write(cs + &quot;\n\necho -e \&quot;\\nOUTPUT TABLE\\n------------\&quot;\n&quot;);
			socketTools.msg(&quot;&lt;strong&gt;OUTPUT TABLE:&lt;/strong&gt;\n&quot;);
	
			cs = await PolicyScript.dump(req,2);
			stream.write(cs + &quot;\n\necho -e \&quot;\\nFORWARD TABLE\\n-------------\&quot;\n&quot;);
			socketTools.msg(&quot;&lt;strong&gt;FORWARD TABLE:&lt;/strong&gt;\n&quot;);
			
			cs = await PolicyScript.dump(req,3);
			stream.write(cs + &quot;\n\necho -e \&quot;\\nSNAT TABLE\\n----------\&quot;\n&quot;);
			socketTools.msg(&quot;&lt;strong&gt;SNAT TABLE:&lt;/strong&gt;\n&quot;);
			
			cs = await PolicyScript.dump(req,4);
			stream.write(cs + &quot;\n\necho -e \&quot;\\nDNAT TABLE\\n----------\&quot;\n&quot;);
			socketTools.msg(&quot;&lt;strong&gt;DNAT TABLE:&lt;/strong&gt;\n&quot;);
			
			cs = await PolicyScript.dump(req, 5);
			stream.write(cs+&quot;\n}\n\n&quot;);
			
			data = await PolicyScript.append(config.get(&#x27;policy&#x27;).footer_file);
			stream.write(data.cs);
			
			/* Close stream. */
			stream.end();
			
			// Update firewall status flags.
			await FirewallModel.updateFirewallStatus(req.body.fwcloud,req.body.firewall,&quot;&amp;~1&quot;);
			socketTools.msgEnd();
			api_resp.getJson(null, api_resp.ACR_OK, &#x27;&#x27;, &#x27;COMPILE&#x27;, null, jsonResp =&gt; res.status(200).json(jsonResp));
		} catch(error) { 
			socketTools.msg(&#x60;\nERROR: ${error}\n&#x60;);
			socketTools.msgEnd();
			api_resp.getJson(null, api_resp.ACR_ERROR, &#x27;&#x27;, &#x27;COMPILE&#x27;, error, jsonResp =&gt; res.status(200).json(jsonResp)) 
		}
	}).on(&#x27;error&#x27;, error =&gt; api_resp.getJson(null, api_resp.ACR_ERROR, &#x27;&#x27;, &#x27;COMPILE&#x27;, error, jsonResp =&gt; res.status(200).json(jsonResp)))
});
/*----------------------------------------------------------------------------------------------------------------------*/

module.exports = router;


    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
